import android.util.Log;

// Beanshell won't let me write "\0".
final String SEP = Character.toString ((char) 0);

Object dialog;          // Used to help coordinate the display of a "busy..." dialog
String parentTabgroup;  // Used to allow entities to be saved as children
String parentTabgroup__;// The tab group which was previously displayed
String redirectTab;     // makes newTab work as expected
String username = "";
String userid   = "";

setFileSyncEnabled(true);
setSyncDelay(5.0f);
setSyncEnabled(true);
setSyncMaxInterval(600.0f);
setSyncMinInterval(5.0f);

/******************************** STRING UTILS ********************************/
String replaceFirst(String haystack, String needle, String replacement) {
  i = haystack.indexOf(needle);
  if (i == -1)           return haystack;
  if (needle.equals("")) return haystack;
  pre  = haystack.substring(0, i                                   );
  post = haystack.substring(   i+needle.length(), haystack.length());
  return pre + replacement + post;
}

String replaceFirst(String haystack, String replacement) {
  return replaceFirst(haystack, "%s", replacement);
}

String translate(String s, Map m) {
  String out = "";

  for (char c : s) {
    String translation = m.get(c);

    if (isNull(translation)) out += c;
    else                     out += translation;
  }

  return out;
}

String escape(String s) {
  Map dict = new HashMap();
  dict.put('\"', "\\\"");
  dict.put('\\', "\\\\");
  dict.put('\b', "\\b" );
  dict.put('\f', "\\f" );
  dict.put('\n', "\\n" );
  dict.put('\r', "\\r" );

  return translate(s, dict);
}

String args2str(Object[] args) {
  String str = "";
  String sep = ", ";

  for (Object o : args) {
    if (o instanceof String) str += "\"" + escape(o) + "\"" + sep;
    else                     str +=               o         + sep;
  }

  // The loop adds a superfluous trailing separator. This removes it.
  str = str.substring(0, str.length() - sep.length());

  return str;
}

// "Function to string". Makes it very slightly less painful to write callback
// functions as strings.
String fun2str(String funName, Object[] args) {
  String argsStr = args2str(args);

  String str = "{funName}({argsStr})";
  str = replaceFirst(str, "{funName}", funName);
  str = replaceFirst(str, "{argsStr}", argsStr);

  return str;
}

String fun2str(String funName, Object args) {
  return fun2str(funName, new Object[]{args});
}

/******************************************************************************/
/*                           DOCUMENT OBJECT MODEL                            */
/******************************************************************************/
String PREVIOUSLY_DISPLAYED_TAB_GROUP = "";
String CURRENTLY_DISPLAYED_TAB_GROUP  = "";

String getType(String ref) {
  Map refToType = new HashMap();
  refToType.put("User/User_List/Users", "dropdown");
  refToType.put("User/User_List/Device_Code", "dropdown");
  refToType.put("User/User_List/Login", "button");
  refToType.put("User/User_List/Module_Guide", "button");
  refToType.put("User/Help/Help", "webview");
  refToType.put("Control/Site/New_Site_Name", "input");
  refToType.put("Control/Site/Year_of_Campaign", "input");
  refToType.put("Control/Site/GPS_Diagnostics", "gpsdiag");
  refToType.put("Control/Site/Create_New_Site", "button");
  refToType.put("Control/Site/Choose_an_Existing_Site", "list");
  refToType.put("Control/Next_IDs/Next_Locus_Locus_ID", "input");
  refToType.put("Control/Next_IDs/Next_Stratum_Feature_ID", "input");
  refToType.put("Control/Next_IDs/Next_FCN_ID", "input");
  refToType.put("Control/Search", "group");
  refToType.put("Control/Search/Search_Term", "input");
  refToType.put("Control/Search/Search_Button", "button");
  refToType.put("Control/Search/Entity_Types", "dropdown");
  refToType.put("Control/Search/Entity_List", "list");
  refToType.put("Site/Site/Site_Site_Name", "input");
  refToType.put("Site/Site/Site_Year_of_Campaign", "input");
  refToType.put("Site/Site/Guide", "webview");
  refToType.put("Site/Site/Trench_ID", "input");
  refToType.put("Site/Site/Trenches", "button");
  refToType.put("Site/Site/List_of_Existing_Trenches", "list");
  refToType.put("Site/Vars/Device_Code", "dropdown");
  refToType.put("Trench/Trench/Trench_Site_Name", "input");
  refToType.put("Trench/Trench/Trench_author", "input");
  refToType.put("Trench/Trench/Trench_Trench_ID", "input");
  refToType.put("Trench/Trench/Team_Members", "input");
  refToType.put("Trench/Trench/Trench_Dimensions", "dropdown");
  refToType.put("Trench/Trench/Grid_SW_Corner_Coordinates", "webview");
  refToType.put("Trench/Trench", "group");
  refToType.put("Trench/Trench/Latitude", "input");
  refToType.put("Trench/Trench/Longitude", "input");
  refToType.put("Trench/Trench", "group");
  refToType.put("Trench/Trench/Northing", "input");
  refToType.put("Trench/Trench/Easting", "input");
  refToType.put("Trench/Trench/Accuracy", "input");
  refToType.put("Trench/Trench/Take_From_GPS_1", "button");
  refToType.put("Trench/Trench/Excavation_Method", "checkbox");
  refToType.put("Trench/Trench/Trench_timestamp", "input");
  refToType.put("Trench/Trench/Set_Date_Closed", "button");
  refToType.put("Trench/Trench/Date_Closed", "input");
  refToType.put("Trench/Trench/Brief_Description", "input");
  refToType.put("Trench/Trench/Your_Discussion", "input");
  refToType.put("Trench/Trench/Add_Trench_Files", "button");
  refToType.put("Trench/Trench/Attached_Trench_Files", "dropdown");
  refToType.put("Trench/Loci/Create_New_Locus", "button");
  refToType.put("Trench/Loci/List_of_Existing_Loci", "list");
  refToType.put("Trench/Strata_Features/Create_New_Stratum_Feature", "button");
  refToType.put("Trench/Strata_Features/List_of_Existing_Strata_Features", "list");
  refToType.put("Trench/FCNs/Create_New_FCN", "button");
  refToType.put("Trench/FCNs/List_of_Existing_FCNs", "list");
  refToType.put("Trench/Diaries/Create_New_Diary", "button");
  refToType.put("Trench/Diaries/List_of_Existing_Diaries", "list");
  refToType.put("Trench/Legacies/Create_New_Legacy", "button");
  refToType.put("Trench/Legacies/List_of_Existing_Legacies", "list");
  refToType.put("Trench/Vars/Trench_Year_of_Campaign", "input");
  refToType.put("Trench/Vars/Device_Code", "dropdown");
  refToType.put("Date_Closed/Date_Closed/Date_Closed", "input");
  refToType.put("Date_Closed/Date_Closed/Set_Date_Closed", "button");
  refToType.put("Date_Closed/Date_Closed/Cancel", "button");
  refToType.put("Trench_Files/Add_Trench_Files", "group");
  refToType.put("Trench_Files/Add_Trench_Files/Trench_Files_Site_Name", "input");
  refToType.put("Trench_Files/Add_Trench_Files/Trench_Files_Year_of_Campaign", "input");
  refToType.put("Trench_Files/Add_Trench_Files/Trench_Files_Trench_ID", "input");
  refToType.put("Trench_Files/Add_Trench_Files/Trench_Files_author", "input");
  refToType.put("Trench_Files/Add_Trench_Files/File_Type", "dropdown");
  refToType.put("Trench_Files/Add_Trench_Files/File_Name", "input");
  refToType.put("Trench_Files/Add_Trench_Files/File_Comment", "input");
  refToType.put("Trench_Files/Add_Trench_Files/Add_Photo", "camera");
  refToType.put("Trench_Files/Add_Trench_Files/Add_Photo_Button_1", "button");
  refToType.put("Trench_Files/Add_Trench_Files/Attach_File", "file");
  refToType.put("Trench_Files/Add_Trench_Files/Attach_File_Button_1", "button");
  refToType.put("Trench_Files/Add_Trench_Files/View_Attached_Files", "viewfiles");
  refToType.put("Trench_Files/Vars/Device_Code", "dropdown");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Locus_Site_Name", "input");
  refToType.put("Locus/General/Locus_Trench_ID", "input");
  refToType.put("Locus/General/Locus_Locus_ID", "input");
  refToType.put("Locus/General/Brief_Description", "input");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Grid_X", "input");
  refToType.put("Locus/General/Grid_Y", "input");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Date_Opened", "input");
  refToType.put("Locus/General/Team_Members", "input");
  refToType.put("Locus/General/Excavation_Method", "checkbox");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Basal_Edge_Definition", "dropdown");
  refToType.put("Locus/General/Contamination", "dropdown");
  refToType.put("Locus/General/Locus_Type", "picture");
  refToType.put("Locus/General/Fill_in_Locus_Type_Details", "button");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Photo_of_Plan", "camera");
  refToType.put("Locus/General/Photo_of_Plan_Button_1", "button");
  refToType.put("Locus/General/Photo_of_Section", "camera");
  refToType.put("Locus/General/Photo_of_Section_Button_1", "button");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Date_Closed", "input");
  refToType.put("Locus/General/Add_Date_Closed", "button");
  refToType.put("Locus/General", "group");
  refToType.put("Locus/General/Locus_author", "input");
  refToType.put("Locus/General/Locus_timestamp", "input");
  refToType.put("Locus/Measure", "group");
  refToType.put("Locus/Measure/Absolute_Height_Top_m", "input");
  refToType.put("Locus/Measure/Absolute_Height_Bottom_m", "input");
  refToType.put("Locus/Measure", "group");
  refToType.put("Locus/Measure/Measure_Length", "input");
  refToType.put("Locus/Measure/Measure_Width", "input");
  refToType.put("Locus/Measure/Measure_Depth", "input");
  refToType.put("Locus/Measure", "group");
  refToType.put("Locus/Measure/NW_Top_Height", "input");
  refToType.put("Locus/Measure/SW_Top_Height", "input");
  refToType.put("Locus/Measure/Center_Top_Height", "input");
  refToType.put("Locus/Measure/NE_Top_Height", "input");
  refToType.put("Locus/Measure/SE_Top_Height", "input");
  refToType.put("Locus/Measure", "group");
  refToType.put("Locus/Measure/NW_Bottom_Height", "input");
  refToType.put("Locus/Measure/SW_Bottom_Height", "input");
  refToType.put("Locus/Measure/Center_Bottom_Height", "input");
  refToType.put("Locus/Measure/NE_Bottom_Height", "input");
  refToType.put("Locus/Measure/SE_Bottom_Height", "input");
  refToType.put("Locus/Measure/Volume_Liters", "input");
  refToType.put("Locus/Cut/Cut_Your_Interpretation", "dropdown");
  refToType.put("Locus/Cut", "group");
  refToType.put("Locus/Cut/Shape_in_Plan", "dropdown");
  refToType.put("Locus/Cut/Shape_of_Cut_-_Note", "input");
  refToType.put("Locus/Cut/Shape_of_Corners", "radio");
  refToType.put("Locus/Cut/Break_of_Slope_-_Top", "radio");
  refToType.put("Locus/Cut/Break_of_Slope_-_Base", "radio");
  refToType.put("Locus/Cut", "group");
  refToType.put("Locus/Cut/Sides_of_Cut", "dropdown");
  refToType.put("Locus/Cut/Shape_of_Base", "dropdown");
  refToType.put("Locus/Cut/Orientation", "dropdown");
  refToType.put("Locus/Cut/Orientation_Degree", "input");
  refToType.put("Locus/Cut/Inclination_of_axis", "dropdown");
  refToType.put("Locus/Cut/Truncation", "input");
  refToType.put("Locus/Construction/Description", "input");
  refToType.put("Locus/Construction/Discussion", "input");
  refToType.put("Locus/Construction/Length", "input");
  refToType.put("Locus/Construction/Width", "input");
  refToType.put("Locus/Construction", "group");
  refToType.put("Locus/Construction/NW_Top_Depth", "input");
  refToType.put("Locus/Construction/SW_Top_Depth", "input");
  refToType.put("Locus/Construction/Center_Top_Depth", "input");
  refToType.put("Locus/Construction/NE_Top_Depth", "input");
  refToType.put("Locus/Construction/SE_Top_Depth", "input");
  refToType.put("Locus/Construction", "group");
  refToType.put("Locus/Construction/NW_Bottom_Depth", "input");
  refToType.put("Locus/Construction/SW_Bottom_Depth", "input");
  refToType.put("Locus/Construction/Center_Bottom_Depth", "input");
  refToType.put("Locus/Construction/NE_Bottom_Depth", "input");
  refToType.put("Locus/Construction/SE_Bottom_Depth", "input");
  refToType.put("Locus/Construction/Mid_X", "input");
  refToType.put("Locus/Construction/Mid_Y", "input");
  refToType.put("Locus/Construction/Sorting", "input");
  refToType.put("Locus/Construction/Notes", "input");
  refToType.put("Locus/Construction/Plans", "input");
  refToType.put("Locus/Construction/Section_Numbers", "input");
  refToType.put("Locus/Deposit/Deposit_Your_Interpretation", "dropdown");
  refToType.put("Locus/Deposit/Texture", "dropdown");
  refToType.put("Locus/Deposit/Texture_Description", "input");
  refToType.put("Locus/Deposit/Soil_Particle_Sorting", "picture");
  refToType.put("Locus/Deposit", "group");
  refToType.put("Locus/Deposit/Material", "dropdown");
  refToType.put("Locus/Deposit/Material_Helper", "button");
  refToType.put("Locus/Deposit/Soil_Colour", "input");
  refToType.put("Locus/Deposit/Add_Munsel_Color", "button");
  refToType.put("Locus/Deposit/Munsel_Colors", "dropdown");
  refToType.put("Locus/Deposit", "group");
  refToType.put("Locus/Deposit/Composition_Type", "dropdown");
  refToType.put("Locus/Deposit/Deposit_Bedding", "dropdown");
  refToType.put("Locus/Deposit", "group");
  refToType.put("Locus/Deposit/Sterile", "radio");
  refToType.put("Locus/Deposit/Deposit_Inclusions", "input");
  refToType.put("Locus/Deposit/Add_New_Sediment_Aggregate", "button");
  refToType.put("Locus/Deposit/Associated_Sediment_Aggregates", "dropdown");
  refToType.put("Locus/Skeleton/Location", "input");
  refToType.put("Locus/Skeleton/Skeleton_Dimensions", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Skeleton_Head", "input");
  refToType.put("Locus/Skeleton/Skeleton_Body", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Skeleton_Left_Arm", "input");
  refToType.put("Locus/Skeleton/Skeleton_Right_Arm", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Skeleton_Left_Leg", "input");
  refToType.put("Locus/Skeleton/Skeleton_Right_Leg", "input");
  refToType.put("Locus/Skeleton/Skeleton_Condition", "input");
  refToType.put("Locus/Skeleton/Skeleton_Surface_Modifications", "input");
  refToType.put("Locus/Skeleton/Skeleton_Environment", "input");
  refToType.put("Locus/Skeleton/Skeleton_Days_Exposed", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Target_A_X", "input");
  refToType.put("Locus/Skeleton/Target_A_Y", "input");
  refToType.put("Locus/Skeleton/Target_A_Z", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Target_B_X", "input");
  refToType.put("Locus/Skeleton/Target_B_Y", "input");
  refToType.put("Locus/Skeleton/Target_B_Z", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Target_C_X", "input");
  refToType.put("Locus/Skeleton/Target_C_Y", "input");
  refToType.put("Locus/Skeleton/Target_C_Z", "input");
  refToType.put("Locus/Skeleton", "group");
  refToType.put("Locus/Skeleton/Target_D_X", "input");
  refToType.put("Locus/Skeleton/Target_D_Y", "input");
  refToType.put("Locus/Skeleton/Target_D_Z", "input");
  refToType.put("Locus/Skeleton/Skeleton_Notes", "input");
  refToType.put("Locus/Int/Your_description", "input");
  refToType.put("Locus/Int/Your_Discussion", "input");
  refToType.put("Locus/Relationships/Create_Relationships_to_This_Locus", "button");
  refToType.put("Locus/Relationships", "group");
  refToType.put("Locus/Relationships/Existing_Relationships_to_This_Locus", "list");
  refToType.put("Locus/Relationships/Selected_Relationship", "webview");
  refToType.put("Locus/Relationships/Load_Related_Locus", "button");
  refToType.put("Locus/Relationships/Delete_Relationship", "button");
  refToType.put("Locus/FCNs/Add_FCN", "button");
  refToType.put("Locus/FCNs/List_of_Related_FCNs", "list");
  refToType.put("Locus/Add/Photo", "camera");
  refToType.put("Locus/Add/Photo_Button_1", "button");
  refToType.put("Locus/Add/Attach_File", "file");
  refToType.put("Locus/Add/Attach_File_Button_1", "button");
  refToType.put("Locus/Add/View_Attached_Files", "viewfiles");
  refToType.put("Locus/Add/Add_Photograph_Log", "button");
  refToType.put("Locus/Add/Select_a_Photograph_Log", "dropdown");
  refToType.put("Locus/Material_Helper/Material_Helper", "dropdown");
  refToType.put("Locus/Material_Helper/Update_Material", "button");
  refToType.put("Locus/Vars/Device_Code", "dropdown");
  refToType.put("Locus/Vars/Locus_Year_of_Campaign", "input");
  refToType.put("Stratum_Feature/General/Record_Type", "radio");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Feature_Type", "dropdown");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Feature_Prefix", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Stratum_Feature_Trench_ID", "input");
  refToType.put("Stratum_Feature/General/Stratum_Feature_ID", "input");
  refToType.put("Stratum_Feature/General/Description", "input");
  refToType.put("Stratum_Feature/General/Interpretation", "input");
  refToType.put("Stratum_Feature/General/Discussion", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Length", "input");
  refToType.put("Stratum_Feature/General/Width", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/NW_Top_Depth", "input");
  refToType.put("Stratum_Feature/General/SW_Top_Depth", "input");
  refToType.put("Stratum_Feature/General/Center_Top_Depth", "input");
  refToType.put("Stratum_Feature/General/NE_Top_Depth", "input");
  refToType.put("Stratum_Feature/General/SE_Top_Depth", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/NW_Bottom_Depth", "input");
  refToType.put("Stratum_Feature/General/SW_Bottom_Depth", "input");
  refToType.put("Stratum_Feature/General/Center_Bottom_Depth", "input");
  refToType.put("Stratum_Feature/General/NE_Bottom_Depth", "input");
  refToType.put("Stratum_Feature/General/SE_Bottom_Depth", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Mid_X", "input");
  refToType.put("Stratum_Feature/General/Mid_Y", "input");
  refToType.put("Stratum_Feature/General/Plans", "input");
  refToType.put("Stratum_Feature/General/Section_Numbers", "input");
  refToType.put("Stratum_Feature/General", "group");
  refToType.put("Stratum_Feature/General/Stratum_Feature_author", "input");
  refToType.put("Stratum_Feature/General/Stratum_Feature_timestamp", "input");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci/Create_Relationships_to_This_Stratum_Feature", "button");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci", "group");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci/Existing_Relationships_to_This_Stratum_Feature", "list");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci/Selected_Relationship", "webview");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci/Load_Related_Locus", "button");
  refToType.put("Stratum_Feature/Stratum_Feature_Loci/Delete_Relationship", "button");
  refToType.put("Stratum_Feature/Add/Photo", "camera");
  refToType.put("Stratum_Feature/Add/Photo_Button_1", "button");
  refToType.put("Stratum_Feature/Add/Attach_File", "file");
  refToType.put("Stratum_Feature/Add/Attach_File_Button_1", "button");
  refToType.put("Stratum_Feature/Add/View_Attached_Files", "viewfiles");
  refToType.put("Stratum_Feature/Add/Guide_2", "webview");
  refToType.put("Stratum_Feature/Add/Add_Photograph_Log", "button");
  refToType.put("Stratum_Feature/Add/Select_a_Photograph_Log", "dropdown");
  refToType.put("Stratum_Feature/Vars/Device_Code", "dropdown");
  refToType.put("Stratum_Feature/Vars/Stratum_Feature_Site_Name", "input");
  refToType.put("Stratum_Feature/Vars/Stratum_Feature_Year_of_Campaign", "input");
  refToType.put("Stratum_Feature/Vars/L_Paren", "input");
  refToType.put("Stratum_Feature/Vars/R_Paren", "input");
  refToType.put("Stratum_Feature/Vars/Last_Feature_Type", "dropdown");
  refToType.put("Stratum_Feature/Vars/Last_Feature_Prefix", "input");
  refToType.put("Sediment_Aggregate/Sediment_Aggregate", "group");
  refToType.put("Sediment_Aggregate/Sediment_Aggregate/Component_Type", "dropdown");
  refToType.put("Sediment_Aggregate/Sediment_Aggregate/Percentage", "input");
  refToType.put("Sediment_Aggregate/Sediment_Aggregate/Soil_Stone_Shape", "picture");
  refToType.put("Sediment_Aggregate/Vars/Locus_ID", "input");
  refToType.put("Sediment_Aggregate/Vars/Trench_ID", "input");
  refToType.put("Sediment_Aggregate/Vars/Device_Code", "dropdown");
  refToType.put("Photograph_Log/Photograph_Log", "group");
  refToType.put("Photograph_Log/Photograph_Log/Photo_Locus_ID", "input");
  refToType.put("Photograph_Log/Photograph_Log/Photo_Stratum_Feature_ID", "input");
  refToType.put("Photograph_Log/Photograph_Log/Photograph_Reference_ID", "input");
  refToType.put("Photograph_Log/Photograph_Log/Scene_Type", "dropdown");
  refToType.put("Photograph_Log/Photograph_Log/Brief_Description", "input");
  refToType.put("Photograph_Log/Vars/Photograph_Log_Site_Name", "input");
  refToType.put("Photograph_Log/Vars/Photograph_Log_Year_of_Campaign", "input");
  refToType.put("Photograph_Log/Vars/Photograph_Trench_ID", "input");
  refToType.put("Photograph_Log/Vars/Device_Code", "dropdown");
  refToType.put("Diary/Diary/Title", "input");
  refToType.put("Diary/Diary", "group");
  refToType.put("Diary/Diary/Timestamp", "input");
  refToType.put("Diary/Diary/Diary_author", "input");
  refToType.put("Diary/Diary/Text", "input");
  refToType.put("Diary/Diary/Photo", "camera");
  refToType.put("Diary/Diary/Photo_Button_1", "button");
  refToType.put("Diary/Vars/Diary_Site_Name", "input");
  refToType.put("Diary/Vars/Diary_Year_of_Campaign", "input");
  refToType.put("Diary/Vars/Diary_Trench_ID", "input");
  refToType.put("Diary/Vars/Device_Code", "dropdown");
  refToType.put("Relationship/Relationships/Parent_Identifier", "webview");
  refToType.put("Relationship/Relationships", "group");
  refToType.put("Relationship/Relationships/Trench_ID", "input");
  refToType.put("Relationship/Relationships/Locus_ID", "input");
  refToType.put("Relationship/Relationships/Relationship_Type", "dropdown");
  refToType.put("Relationship/Relationships/Search", "button");
  refToType.put("Relationship/Relationships", "group");
  refToType.put("Relationship/Relationships/Add_Relationship", "button");
  refToType.put("Relationship/Relationships/Proposed_Relationship", "webview");
  refToType.put("Relationship/Relationships/Delete_Relationship", "button");
  refToType.put("Relationship/Relationships/Selected_Relationship", "webview");
  refToType.put("Relationship/Relationships", "group");
  refToType.put("Relationship/Relationships/Unrelated_Loci", "list");
  refToType.put("Relationship/Relationships/Existing_Relationships", "list");
  refToType.put("Relationship/Legacies/Create_New_Legacy", "button");
  refToType.put("Relationship/Legacies/List_of_Existing_Legacies", "list");
  refToType.put("Relationship/Vars/Relationship_Site_Name", "input");
  refToType.put("Relationship/Vars/Relationship_Year_of_Campaign", "input");
  refToType.put("Stratum_Feature_Relationship/Relationships/Parent_Identifier", "webview");
  refToType.put("Stratum_Feature_Relationship/Relationships", "group");
  refToType.put("Stratum_Feature_Relationship/Relationships/Trench_ID", "input");
  refToType.put("Stratum_Feature_Relationship/Relationships/Locus_ID", "input");
  refToType.put("Stratum_Feature_Relationship/Relationships/Search", "button");
  refToType.put("Stratum_Feature_Relationship/Relationships", "group");
  refToType.put("Stratum_Feature_Relationship/Relationships/Add_Relationship", "button");
  refToType.put("Stratum_Feature_Relationship/Relationships/Proposed_Relationship", "webview");
  refToType.put("Stratum_Feature_Relationship/Relationships/Delete_Relationship", "button");
  refToType.put("Stratum_Feature_Relationship/Relationships/Selected_Relationship", "webview");
  refToType.put("Stratum_Feature_Relationship/Relationships", "group");
  refToType.put("Stratum_Feature_Relationship/Relationships/Unrelated_Loci", "list");
  refToType.put("Stratum_Feature_Relationship/Relationships/Existing_Relationships", "list");
  refToType.put("Stratum_Feature_Relationship/Legacies/Create_New_Legacy", "button");
  refToType.put("Stratum_Feature_Relationship/Legacies/List_of_Existing_Legacies", "list");
  refToType.put("Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Site_Name", "input");
  refToType.put("Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Year_of_Campaign", "input");
  refToType.put("FCN/General/FCN_ID", "input");
  refToType.put("FCN/General/FCN_Site_Name", "input");
  refToType.put("FCN/General/FCN_Trench_ID", "input");
  refToType.put("FCN/General/Locus_ID", "input");
  refToType.put("FCN/General", "group");
  refToType.put("FCN/General/Latitude", "input");
  refToType.put("FCN/General/Longitude", "input");
  refToType.put("FCN/General", "group");
  refToType.put("FCN/General/Northing", "input");
  refToType.put("FCN/General/Easting", "input");
  refToType.put("FCN/General/Accuracy", "input");
  refToType.put("FCN/General/Take_From_GPS_1", "button");
  refToType.put("FCN/General/Collection_Method", "dropdown");
  refToType.put("FCN/General/FCN_Class", "dropdown");
  refToType.put("FCN/General/FCN_Quantity", "input");
  refToType.put("FCN/General/FCN_Weight_g", "input");
  refToType.put("FCN/General", "group");
  refToType.put("FCN/General/Volume_Liters", "input");
  refToType.put("FCN/General/Washed", "radio");
  refToType.put("FCN/General/Weighted", "radio");
  refToType.put("FCN/General/Analyzed", "radio");
  refToType.put("FCN/General/FCN_Group_Comment", "input");
  refToType.put("FCN/General/Attach_File", "file");
  refToType.put("FCN/General/Attach_File_Button_1", "button");
  refToType.put("FCN/General/View_Attached_Files", "viewfiles");
  refToType.put("FCN/General/Attach_Photograph", "camera");
  refToType.put("FCN/General/Attach_Photograph_Button_1", "button");
  refToType.put("FCN/Vars/FCN_Year_of_Campaign", "input");
  refToType.put("FCN/Vars/Device_Code", "dropdown");
  refToType.put("Soil_Munsel_Color/Add_Soil_Munsel_Color/Soil_Munsel_Color", "dropdown");
  refToType.put("Soil_Munsel_Color/Vars/Soil_Munsel_Color_Locus_ID", "input");
  refToType.put("Soil_Munsel_Color/Vars/Device_Code", "dropdown");
  refToType.put("Legacy/Legacy", "group");
  refToType.put("Legacy/Legacy/Legacy_Site_Name", "input");
  refToType.put("Legacy/Legacy/Legacy_Year_of_Campaign", "input");
  refToType.put("Legacy/Legacy", "group");
  refToType.put("Legacy/Legacy/Legacy_Trench_ID", "input");
  refToType.put("Legacy/Legacy/Legacy_Locus_ID", "input");
  refToType.put("Legacy/Var/Device_Code", "dropdown");

  String type = refToType.get(ref);
  if (type == null) return "";
  else              return type;
}

List getTabGroups() {
  List tabGroups = new ArrayList();
  tabGroups.add("User");
  tabGroups.add("Control");
  tabGroups.add("Site");
  tabGroups.add("Trench");
  tabGroups.add("Date_Closed");
  tabGroups.add("Trench_Files");
  tabGroups.add("Locus");
  tabGroups.add("Stratum_Feature");
  tabGroups.add("Sediment_Aggregate");
  tabGroups.add("Photograph_Log");
  tabGroups.add("Diary");
  tabGroups.add("Relationship");
  tabGroups.add("Stratum_Feature_Relationship");
  tabGroups.add("FCN");
  tabGroups.add("Soil_Munsel_Color");
  tabGroups.add("Legacy");
  return tabGroups;
}

boolean isFlaggedNodata(String tabGroup) {
  List flaggedTabGroups = new ArrayList();
  flaggedTabGroups.add("User");
  flaggedTabGroups.add("Control");
  flaggedTabGroups.add("Date_Closed");
  flaggedTabGroups.add("Relationship");
  flaggedTabGroups.add("Stratum_Feature_Relationship");
  return flaggedTabGroups.contains(tabGroup);
}

void updateDisplayedTabGroup(String tabGroup) {
  PREVIOUSLY_DISPLAYED_TAB_GROUP = CURRENTLY_DISPLAYED_TAB_GROUP;
  CURRENTLY_DISPLAYED_TAB_GROUP  = tabGroup;
}

String getPreviousTabGroup() {
  return getPreviouslyDisplayedTabGroup();
}

String getPreviouslyDisplayedTabGroup() {
  return PREVIOUSLY_DISPLAYED_TAB_GROUP;
}

String getDisplayedTabGroup() {
  return CURRENTLY_DISPLAYED_TAB_GROUP;
}

boolean isDisplayed(String ref) {
  return getDisplayedTabGroup().equals(ref);
}

String getTabGroupRef(String fullRef) {
  Boolean lastPartOnly = false;
  return getTabGroupRef(fullRef, lastPartOnly);
}

String getTabGroupRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 1) return null;
  return parts[0];
}

String getTabRef(String fullRef) {
  Boolean lastPartOnly = false;
  return getTabRef(fullRef, lastPartOnly);
}

String getTabRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 2) return null;
  if (lastPartOnly) return                  parts[1];
  else              return parts[0] + "/" + parts[1];
}

String getLastRefPart(String fullRef) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");
  return parts[parts.length-1];
}

String getGuiElementRef(String fullRef) {
  Boolean lastPartOnly = true;
  return getGuiElementRef(fullRef, lastPartOnly);
}

String getGuiElementRef(String fullRef, Boolean lastPartOnly) {
  if (isNull(fullRef)) {
    return null;
  }

  String[] parts = fullRef.split("/");

  if (parts.length < 3) return null;
  if (lastPartOnly) return parts[2];
  else              return fullRef;
}

String getArch16nKey(String ref) {
  String lastRefPart = getLastRefPart(ref);

  if (isNull(lastRefPart)) return null;
  else                     return "{" + lastRefPart + "}";
}

String guessArch16nVal(String ref) {
  String arch16nKey = getArch16nKey(ref);

  if (isNull(arch16nKey)) return "";
  arch16nKey = arch16nKey.replaceAll("_", " ");
  arch16nKey = arch16nKey.replaceAll("^\\{", "");
  arch16nKey = arch16nKey.replaceAll("\\}$", "");
  return arch16nKey;
}

String getAttributeName(String ref) {
  String guiElementRef = getGuiElementRef(ref);
  if (isNull(guiElementRef)) {
    return null;
  }

  String attributeName = guiElementRef.replaceAll("_", " ");
  return attributeName;
}

String getArchEntType(String ref) {
  String tabGroupRef = getTabGroupRef(ref);
  if (isNull(tabGroupRef)) {
    return null;
  }

  String archEntType = tabGroupRef.replaceAll("_", " ");
  return archEntType;
}

String getArchEntTypePascalCased(String ref) {
  String archEntType = getArchEntType(ref);
  if (archEntType == null) {
    return archEntType;
  }

  return archEntType.replaceAll(" ", "");
}

/******************************************************************************/
/*                            BINDING ACCUMULATOR                             */
/*                                                                            */
/* The binding accumulator allows onEvent bindings for the same element to    */
/* accumulate over multiple onEvent calls instead of having later calls       */
/* override earlier ones.                                                     */
/*                                                                            */
/* It also adds support for a several additional events:                      */
/*   - "blur" --- This is merely an interface to make code for adding "blur"  */
/*         events more consistent.                                            */
/*   - "copy" --- Triggered as a record is duplicated, immediately before it  */
/*         is first saved.                                                    */
/*   - "create" --- Triggered after a record is first created.                */
/*   - "delete" --- Triggered after a record is deleted.                      */
/*   - "prefetch" --- Triggered before the "fetch" event. More specifically,  */
/*         this event is triggered before a tab group is fetched and          */
/*         displayed.                                                         */
/*   - "fetch" --- Triggered after a record is fetched and displayed in a     */
/*         given tab group.                                                   */
/*   - "focus" --- This is merely an interface to make code for adding        */
/*         "focus" events more consistent.                                    */
/*   - "leave" --- Triggered after a given tab group is navigated away        */
/*         from. Note that this event cannot be triggered when the FAIMS app  */
/*         is exited.                                                         */
/*   - "save" --- Triggered each time a tab group is saved. This includes the */
/*         first time the tab group is saved as well as subsequent            */
/*         onSave(String, Boolean) calls.                                     */
/*                                                                            */
/* A single call to `bindOnEvents` must occur after all the `addOnEvent` and  */
/* `delOnEvents` calls. Calling `bindOnEvents` is what actually establishes   */
/* the bindings once they have been added to the accumulator.                 */
/******************************************************************************/
Map    EVENTS        = new HashMap(); // (ref, event type) -> callback statement
Set    CUSTOM_EVENTS = new HashSet(); // Events not handled by `onEvent`
CUSTOM_EVENTS.add("blur");
CUSTOM_EVENTS.add("copy");
CUSTOM_EVENTS.add("create");
CUSTOM_EVENTS.add("delete");
CUSTOM_EVENTS.add("fetch");
CUSTOM_EVENTS.add("focus");
CUSTOM_EVENTS.add("leave");
CUSTOM_EVENTS.add("prefetch");
CUSTOM_EVENTS.add("save");

String getKey(String ref, String event) {
  return ref + SEP + event;
}

/* Returns the set of statements bound to an element at `ref` and occuring on
 * `event`.
 */
ArrayList getStatements(String ref, String event) {
  String    key = getKey(ref, event);
  ArrayList val = (ArrayList) EVENTS.get(key);

  if (val == null) return new ArrayList();
  else             return val;
}

void addStatement(String ref, String event, String statement) {
  // In the case that a statement already exists for a given (`ref`, `event`)
  // pair, writing `val.add(statement);` will be enough to add the extra
  // statement. This is because `getStatements` returns a reference to a list.
  // In the case just described, the list is stored in the `EVENTS` map.
  // However, sometimes `getStatements` returns empty lists which are not stored
  // in that map. In this case, calling `EVENTS.put` is required.

  String    key = getKey(ref, event);
  ArrayList val = getStatements(ref, event);
  val.add(statement);
  EVENTS.put(key, val);
}

String getStatementsString(String ref, String event) {
  ArrayList stmts = getStatements(ref, event);
  String stmtsStr = "";
  for (String s : stmts) {
    stmtsStr += s;
    stmtsStr += "; ";
  }
  return stmtsStr;
}

boolean hasOnEvent(String ref, String event, String statement) {
  return getStatements(ref, event).contains(statement);
}

void delOnEvent(String ref, String event, String statement) {
  while(getStatements(ref, event).remove(statement));
}

void addOnEvent(String ref, String event, String statement) {
  // Calling `delOnEvent()` first ensures statement occurs once in the list, at
  // the end.
  delOnEvent  (ref, event, statement);
  addStatement(ref, event, statement);
}

void bindOnEvent(String ref, String event) {
  String stmtsStr     = getStatementsString(ref, event);
  String focusStmtStr = getStatementsString(ref, "focus");
  String blurStmtStr  = getStatementsString(ref, "blur" );

  if (!CUSTOM_EVENTS.contains(event)) {
    onEvent(ref, event, stmtsStr);
  } else if (event.equals("focus")) {
    onFocus(ref, focusStmtStr, blurStmtStr);
  } else if (event.equals("blur" )) {
    onFocus(ref, focusStmtStr, blurStmtStr);
  } else {
    ; // Other events are implemented using auto-generated callback functions
  }
}

void bindOnEvents() {
  for (String key : EVENTS.keySet()) {
    refevent = key.split(SEP);
    ref   = refevent[0];
    event = refevent[1];
    bindOnEvent(ref, event);
  }
}

void onLeaveTabGroup() {
  onLeaveTabGroup(getPreviouslyDisplayedTabGroup());
}

/* Execute the "leave" event for the tab group at `ref` if a callback for it
 * exists.
 */
void onLeaveTabGroup(String ref) {
  String event    = "leave";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}

/* Establishes `onEvent` bindings necessary to make the "leave" event work. The
 * "leave" event is really triggered upon "show" of another tab.
 */
for (tg : getTabGroups()) {
  String ref      = tg;
  String event    = "show";
  String callback;

  // Update (previously) displayed tab group
  callback = fun2str("updateDisplayedTabGroup", ref);
  addOnEvent(ref, event, callback);

  // Trigger on leave tab group event
  callback = "onLeaveTabGroup()";
  addOnEvent(ref, event, callback);
}

/******************************* LOCALSETTINGS ********************************/
void makeLocalID(){
  fetchOne("CREATE TABLE IF NOT EXISTS localSettings (key text primary key, value text);", null);
  fetchOne("DROP VIEW IF EXISTS parentchild;", null);
  fetchOne("CREATE VIEW parentchild AS "+
           "SELECT parent.uuid as parentuuid, child.uuid as childuuid, parent.participatesverb as parentparticipatesverb, parent.relationshipid, parent.aenttypename as parentaenttypename, child.participatesverb as childparticipatesverb, child.aenttypename as childaenttypename "+
           "  FROM (SELECT uuid, participatesverb, aenttypename, relationshipid"+
           "          FROM latestnondeletedaentreln "+
           "          JOIN relationship USING (relationshipid) "+
           "          JOIN latestnondeletedarchent USING (uuid) "+
           "          JOIN aenttype USING (aenttypeid)) parent "+
           "  JOIN (SELECT uuid, relationshipid, participatesverb, aenttypename "+
           "          FROM latestnondeletedaentreln "+
           "          JOIN relationship USING (relationshipid) "+
           "          JOIN latestnondeletedarchent USING (uuid) "+
           "          JOIN aenttype USING (aenttypeid)) child "+
           "    ON (parent.relationshipid = child.relationshipid AND parent.uuid != child.uuid);", null);
}
makeLocalID();

void insertIntoLocalSettings(String ref) {
  String val = getFieldValue(ref);
  insertIntoLocalSettings(ref, val);
}

void insertIntoLocalSettings(String key, String val) {
  fetchOne("REPLACE INTO localSettings(key, value) VALUES('" + key + "', '" + val + "');");
}

void insertIntoLocalSettings(String key, Integer val) {
  insertIntoLocalSettings(key, Integer.toString(val));
}

void insertIntoLocalSettingsOnChange(String ref) {
  String val = getFieldValue(ref);

  String insertCallback = fun2str("insertIntoLocalSettings", ref);

  addOnEvent(ref, "blur",  insertCallback);
  addOnEvent(ref, "click", insertCallback);
}

void setFieldValueFromLocalSettings(String key, String ref, boolean doOverwrite) {
  String val = getFieldValue(ref);
  if (!isNull(val) && !doOverwrite) {
    return;
  }

  String q = "SELECT value FROM localSettings WHERE key = '" + key + "';";
  fetchOne(q, new FetchCallback() {
    onFetch(result) {
      if (!isNull(result)) {
        setFieldValue(ref, result.get(0));
      }
    }
  });
}

void setFieldValueFromLocalSettings(String key, String ref) {
  boolean doOverwrite = false;
  setFieldValueFromLocalSettings(key, ref);
}

void setFieldValueFromLocalSettings(String ref, boolean doOverwrite) {
  setFieldValueFromLocalSettings(ref, ref, doOverwrite);
}

void setFieldValueFromLocalSettings(String ref) {
  setFieldValueFromLocalSettings(ref, false);
}

void setFieldValueFromLocalSettingsOnShow(String ref, boolean doOverwrite) {
  String cb = fun2str(
      "setFieldValueFromLocalSettings",
      new Object[]{ref, doOverwrite}
  );

  addOnEvent(getTabGroupRef(ref), "show", cb);
}

void setFieldValueFromLocalSettingsOnShow(String ref) {
  boolean doOverwrite = false;
  setFieldValueFromLocalSettingsOnShow(ref, doOverwrite);
}

/* Causes the value of the field given by `ref` to be saved each time it is
 * modified (on blur). The value of the field is restored when the tab group
 * containing the field is displayed.
 *
 * This function depends on `addOnEvent`. Therefore this function must be called
 * after `addOnEvent` is defined, but before `bindOnEvents` is called. This will
 * be so if the call is made in the autogenerator's `logic` tags.
 */
void persistOverSessions(String ref) {
  setFieldValueFromLocalSettingsOnShow(ref);
  insertIntoLocalSettingsOnChange     (ref);
}

void persistOverSessions(String ref, boolean doOverwrite) {
  setFieldValueFromLocalSettingsOnShow(ref, doOverwrite);
  insertIntoLocalSettingsOnChange     (ref);
}

persistOverSessions("User/User_List/Device_Code", false);
persistOverSessions("Control/Site/New_Site_Name", false);
persistOverSessions("Control/Site/Year_of_Campaign", false);
persistOverSessions("Relationship/Relationships/Relationship_Type", true);

/*************************** FIELD COPYING HELPERS ****************************/
/* Provides an easy way to copy field values, even between vocabs.            */
/******************************************************************************/
boolean setMenuValue(String ref, String vocabName) {
  String attrName = getAttributeName(ref);
  String vocabId = getVocabId(attrName, vocabName);

  if (isNull(vocabId))
    return false;
  else {
    setFieldValue(ref, vocabId);
    return true;
  }
}

void copyFieldValue(String src, String dst) {
  Boolean doFindVocabId = true;
  copyFieldValue(src, dst, doFindVocabId);
}

/* `src`           The ref of the source field.
 * `dst`           The ref of the destination field.
 * `doFindVocabId` If this is true, and the properties/attributes of `src` and
 *                 `dst` are different, `copyFieldValue` treats `src` and `dst`
 *                 as if they were menus. Therefore, to copy the value seen by
 *                 the user (i.e. the vocabName of `src`), a database query is
 *                 performed. The query determines the which vocabId of `dst`
 *                 will make it display the same vocabName as `src`.
 *
 *                 If `doFindVocabId` is false, the value returned by
 *                 `getFieldValue` is copied, without any database accesses.
 */
void copyFieldValue(String src, String dst, Boolean doFindVocabId) {
  String vocabIdSrc   = getFieldValue(src);
  String vocabNameSrc = getFieldValue(src, true);

  String attrNameSrc = getAttributeName(src);
  String attrNameDst = getAttributeName(dst);

  if (attrNameSrc.equals(attrNameDst) || !doFindVocabId) {
    setFieldValue(dst, vocabIdSrc);
    return;
  }

  if (!setMenuValue(dst, vocabNameSrc)) {
    // Fall back to dumb field copying
    copyFieldValue(src, dst, false);
  }
}

boolean isSelected(String ref, String vocabName) {
  String vocabNameActual = getMenuValue(ref);

  if (vocabNameActual == null)
    return vocabNameActual == vocabName;
  else
    return vocabNameActual.equals(vocabName);
}

void clearField(String ref) {
  switch(getType(ref)) {
    case "dropdown": setFieldValue(ref, null); break;
    case "list":     return;
    default:         setFieldValue(ref, "");
  }
}

void inheritFieldValue(
    String src,
    String dst,
    boolean doCheckParent,
    boolean doFindVocabId
) {
  String fun = "";
  fun += "if (!{check} || getDisplayedTabGroup().equals(\"{parent}\"))";
  fun += "  copyFieldValue(\"{src}\", \"{dst}\", {find})";

  fun = replaceFirst(fun, "{check}",  doCheckParent + "");
  fun = replaceFirst(fun, "{parent}", getTabGroupRef(src));
  fun = replaceFirst(fun, "{src}",    src);
  fun = replaceFirst(fun, "{dst}",    dst);
  fun = replaceFirst(fun, "{find}",   doFindVocabId + "");


  String dstParent = getTabGroupRef(dst);
  if (isFlaggedNodata(dstParent)) addOnEvent(dstParent, "show",   fun);
  else                            addOnEvent(dstParent, "create", fun);
}

/* If `doCheckParent`, then the value at `src` will only be inherited to `dst`
 * if `getTabGroupRef(src)` was the previously displayed tab group.
 */
void inheritFieldValue(String src, String dst, boolean doCheckParent) {
  inheritFieldValue(src, dst, doCheckParent, false);
}

void inheritFieldValue(String src, String dst) {
  inheritFieldValue(src, dst, true);
}

inheritFieldValue("Control/Site/New_Site_Name", "Site/Site/Site_Site_Name", true);
inheritFieldValue("Control/Site/Year_of_Campaign", "Site/Site/Site_Year_of_Campaign", true);
inheritFieldValue("User/User_List/Device_Code", "Site/Vars/Device_Code", false);
inheritFieldValue("Site/Site/Site_Site_Name", "Trench/Trench/Trench_Site_Name", true);
inheritFieldValue("Site/Site/Trench_ID", "Trench/Trench/Trench_Trench_ID", true);
inheritFieldValue("Site/Site/Site_Year_of_Campaign", "Trench/Vars/Trench_Year_of_Campaign", true);
inheritFieldValue("User/User_List/Device_Code", "Trench/Vars/Device_Code", false);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "Trench_Files/Add_Trench_Files/Trench_Files_Site_Name", true);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "Trench_Files/Add_Trench_Files/Trench_Files_Year_of_Campaign", true);
inheritFieldValue("Trench/Trench/Trench_Trench_ID", "Trench_Files/Add_Trench_Files/Trench_Files_Trench_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Trench_Files/Vars/Device_Code", false);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "Locus/General/Locus_Site_Name", true);
inheritFieldValue("Trench/Trench/Trench_Trench_ID", "Locus/General/Locus_Trench_ID", true);
inheritFieldValue("Trench/Trench/Team_Members", "Locus/General/Team_Members", true);
inheritFieldValue("User/User_List/Device_Code", "Locus/Vars/Device_Code", false);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "Locus/Vars/Locus_Year_of_Campaign", true);
inheritFieldValue("Trench/Trench/Trench_Trench_ID", "Stratum_Feature/General/Stratum_Feature_Trench_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Stratum_Feature/Vars/Device_Code", false);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "Stratum_Feature/Vars/Stratum_Feature_Site_Name", true);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "Stratum_Feature/Vars/Stratum_Feature_Year_of_Campaign", true);
inheritFieldValue("Locus/General/Locus_Locus_ID", "Sediment_Aggregate/Vars/Locus_ID", true);
inheritFieldValue("Locus/General/Locus_Trench_ID", "Sediment_Aggregate/Vars/Trench_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Sediment_Aggregate/Vars/Device_Code", false);
inheritFieldValue("Locus/General/Locus_Locus_ID", "Photograph_Log/Photograph_Log/Photo_Locus_ID", true);
inheritFieldValue("Stratum_Feature/General/Stratum_Feature_ID", "Photograph_Log/Photograph_Log/Photo_Stratum_Feature_ID", true);
inheritFieldValue("Locus/General/Locus_Site_Name", "Photograph_Log/Vars/Photograph_Log_Site_Name", true);
inheritFieldValue("Stratum_Feature/Vars/Stratum_Feature_Site_Name", "Photograph_Log/Vars/Photograph_Log_Site_Name", true);
inheritFieldValue("Locus/Vars/Locus_Year_of_Campaign", "Photograph_Log/Vars/Photograph_Log_Year_of_Campaign", true);
inheritFieldValue("Stratum_Feature/Vars/Stratum_Feature_Year_of_Campaign", "Photograph_Log/Vars/Photograph_Log_Year_of_Campaign", true);
inheritFieldValue("Locus/General/Locus_Trench_ID", "Photograph_Log/Vars/Photograph_Trench_ID", true);
inheritFieldValue("Stratum_Feature/General/Stratum_Feature_Trench_ID", "Photograph_Log/Vars/Photograph_Trench_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Photograph_Log/Vars/Device_Code", false);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "Diary/Vars/Diary_Site_Name", true);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "Diary/Vars/Diary_Year_of_Campaign", true);
inheritFieldValue("Trench/Trench/Trench_Trench_ID", "Diary/Vars/Diary_Trench_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Diary/Vars/Device_Code", false);
inheritFieldValue("Locus/General/Locus_Site_Name", "Relationship/Vars/Relationship_Site_Name", false);
inheritFieldValue("Locus/Vars/Locus_Year_of_Campaign", "Relationship/Vars/Relationship_Year_of_Campaign", false);
inheritFieldValue("Stratum_Feature/Vars/Stratum_Feature_Site_Name", "Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Site_Name", false);
inheritFieldValue("Stratum_Feature/Vars/Stratum_Feature_Year_of_Campaign", "Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Year_of_Campaign", false);
inheritFieldValue("Locus/General/Locus_Site_Name", "FCN/General/FCN_Site_Name", true);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "FCN/General/FCN_Site_Name", true);
inheritFieldValue("Locus/General/Locus_Trench_ID", "FCN/General/FCN_Trench_ID", true);
inheritFieldValue("Trench/Trench/Trench_Trench_ID", "FCN/General/FCN_Trench_ID", true);
inheritFieldValue("Locus/General/Locus_Locus_ID", "FCN/General/Locus_ID", true);
inheritFieldValue("Locus/Vars/Locus_Year_of_Campaign", "FCN/Vars/FCN_Year_of_Campaign", true);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "FCN/Vars/FCN_Year_of_Campaign", true);
inheritFieldValue("User/User_List/Device_Code", "FCN/Vars/Device_Code", false);
inheritFieldValue("Locus/General/Locus_Locus_ID", "Soil_Munsel_Color/Vars/Soil_Munsel_Color_Locus_ID", true);
inheritFieldValue("User/User_List/Device_Code", "Soil_Munsel_Color/Vars/Device_Code", false);
inheritFieldValue("Relationship/Vars/Relationship_Site_Name", "Legacy/Legacy/Legacy_Site_Name", true);
inheritFieldValue("Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Site_Name", "Legacy/Legacy/Legacy_Site_Name", true);
inheritFieldValue("Trench/Trench/Trench_Site_Name", "Legacy/Legacy/Legacy_Site_Name", true);
inheritFieldValue("Relationship/Vars/Relationship_Year_of_Campaign", "Legacy/Legacy/Legacy_Year_of_Campaign", true);
inheritFieldValue("Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Year_of_Campaign", "Legacy/Legacy/Legacy_Year_of_Campaign", true);
inheritFieldValue("Trench/Vars/Trench_Year_of_Campaign", "Legacy/Legacy/Legacy_Year_of_Campaign", true);
inheritFieldValue("User/User_List/Device_Code", "Legacy/Var/Device_Code", false);

/**************************** NEW TAB REDIRECTION *****************************/
/* Causes a call to `newTab("tab/path")` to take the user to the specified    */
/* tab.                                                                       */
/******************************************************************************/

void newTab(String tab, Boolean resolveTabGroups) {
  if (!resolveTabGroups) {
    return newTab(tab);
  }

  String tabGroupRef = getTabGroupRef(tab);
  String tabRef      = getTabRef     (tab);

  if (!isDisplayed(tabGroupRef)) newTabGroup(tabGroupRef);
  if (!isNull     (tabRef     )) newTab     (tabRef);
}

/******************************************************************************/
/*                           DROPDOWN VALUE GETTER                            */
/*                                                                            */
/* For consistency with `getListItemValue()`.                                 */
/******************************************************************************/
String DROPDOWN_ITEM_VALUE = null;

String getDropdownItemValue() {
  return DROPDOWN_ITEM_VALUE;
}

addOnEvent("User/User_List/Users", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"User/User_List/Users\")");
addOnEvent("User/User_List/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"User/User_List/Device_Code\")");
addOnEvent("Control/Search/Entity_Types", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Control/Search/Entity_Types\")");
addOnEvent("Site/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Site/Vars/Device_Code\")");
addOnEvent("Trench/Trench/Trench_Dimensions", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Trench/Trench/Trench_Dimensions\")");
addOnEvent("Trench/Trench/Attached_Trench_Files", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Trench/Trench/Attached_Trench_Files\")");
addOnEvent("Trench/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Trench/Vars/Device_Code\")");
addOnEvent("Trench_Files/Add_Trench_Files/File_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Trench_Files/Add_Trench_Files/File_Type\")");
addOnEvent("Trench_Files/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Trench_Files/Vars/Device_Code\")");
addOnEvent("Locus/General/Basal_Edge_Definition", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/General/Basal_Edge_Definition\")");
addOnEvent("Locus/General/Contamination", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/General/Contamination\")");
addOnEvent("Locus/Cut/Cut_Your_Interpretation", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Cut_Your_Interpretation\")");
addOnEvent("Locus/Cut/Shape_in_Plan", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Shape_in_Plan\")");
addOnEvent("Locus/Cut/Sides_of_Cut", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Sides_of_Cut\")");
addOnEvent("Locus/Cut/Shape_of_Base", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Shape_of_Base\")");
addOnEvent("Locus/Cut/Orientation", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Orientation\")");
addOnEvent("Locus/Cut/Inclination_of_axis", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Cut/Inclination_of_axis\")");
addOnEvent("Locus/Deposit/Deposit_Your_Interpretation", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Deposit_Your_Interpretation\")");
addOnEvent("Locus/Deposit/Texture", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Texture\")");
addOnEvent("Locus/Deposit/Material", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Material\")");
addOnEvent("Locus/Deposit/Munsel_Colors", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Munsel_Colors\")");
addOnEvent("Locus/Deposit/Composition_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Composition_Type\")");
addOnEvent("Locus/Deposit/Deposit_Bedding", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Deposit_Bedding\")");
addOnEvent("Locus/Deposit/Associated_Sediment_Aggregates", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Deposit/Associated_Sediment_Aggregates\")");
addOnEvent("Locus/Add/Select_a_Photograph_Log", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Add/Select_a_Photograph_Log\")");
addOnEvent("Locus/Material_Helper/Material_Helper", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Material_Helper/Material_Helper\")");
addOnEvent("Locus/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Locus/Vars/Device_Code\")");
addOnEvent("Stratum_Feature/Add/Select_a_Photograph_Log", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Stratum_Feature/Add/Select_a_Photograph_Log\")");
addOnEvent("Stratum_Feature/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Stratum_Feature/Vars/Device_Code\")");
addOnEvent("Stratum_Feature/Vars/Last_Feature_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Stratum_Feature/Vars/Last_Feature_Type\")");
addOnEvent("Sediment_Aggregate/Sediment_Aggregate/Component_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Sediment_Aggregate/Sediment_Aggregate/Component_Type\")");
addOnEvent("Sediment_Aggregate/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Sediment_Aggregate/Vars/Device_Code\")");
addOnEvent("Photograph_Log/Photograph_Log/Scene_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Photograph_Log/Photograph_Log/Scene_Type\")");
addOnEvent("Photograph_Log/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Photograph_Log/Vars/Device_Code\")");
addOnEvent("Diary/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Diary/Vars/Device_Code\")");
addOnEvent("Relationship/Relationships/Relationship_Type", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Relationship/Relationships/Relationship_Type\")");
addOnEvent("FCN/General/Collection_Method", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"FCN/General/Collection_Method\")");
addOnEvent("FCN/General/FCN_Class", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"FCN/General/FCN_Class\")");
addOnEvent("FCN/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"FCN/Vars/Device_Code\")");
addOnEvent("Soil_Munsel_Color/Add_Soil_Munsel_Color/Soil_Munsel_Color", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Soil_Munsel_Color/Add_Soil_Munsel_Color/Soil_Munsel_Color\")");
addOnEvent("Soil_Munsel_Color/Vars/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Soil_Munsel_Color/Vars/Device_Code\")");
addOnEvent("Legacy/Var/Device_Code", "click", "DROPDOWN_ITEM_VALUE = getFieldValue(\"Legacy/Var/Device_Code\")");

/******************************************************************************/
/*                             MENU VALUE GETTER                              */
/*                                                                            */
/* Provides simple ways of getting a menu's vocabname as opposed to the       */
/* default, which is the vocabid.                                             */
/******************************************************************************/
// Map from vocabid to vocabname. Populated by `fetchMenuValues()`.
Map VOCABID_TO_VOCABNAME = null;
Map VOCABNAME_TO_VOCABID = null;


void setVocabId(String attrName, String vocabName, String vocabId) {
  String key = attrName + SEP + vocabName;
  String val = vocabId;

  VOCABNAME_TO_VOCABID.put(key, val);
}

String getVocabId(String attrName, String vocabName) {
  return VOCABNAME_TO_VOCABID.get(attrName + SEP + vocabName);
}

/*
 * Initialises `VOCABID_TO_VOCABNAME` with the (vocabid -> vocabname) mapping of
 * every menu.
 */
void fetchMenuValues() {
  VOCABID_TO_VOCABNAME = new HashMap();
  VOCABNAME_TO_VOCABID = new HashMap();

  String q = "";
  q += "    SELECT vocabid, vocabname, attributename";
  q += "      FROM vocabulary";
  q += " LEFT JOIN attributekey";
  q += "     USING (attributeid)";

  FetchCallback populateHashMap = new FetchCallback() {
    onFetch(result) {
      // Populate VOCABID_TO_VOCABNAME
      for (row : result) {
        String vocabId   = row.get(0);
        String vocabName = row.get(1);
        VOCABID_TO_VOCABNAME.put(vocabId, vocabName);
      }

      // Populate VOCABNAME_TO_VOCABID
      for (row : result) {
        String vocabId   = row.get(0);
        String vocabName = row.get(1);
        String attrName  = row.get(2);


        setVocabId(attrName, vocabName, vocabId);
      }
    }
  };

  fetchAll(q, populateHashMap);
}

fetchMenuValues();

/* Returns a menu's vocabname, instead of the (counter-intuitive) vocabid.
 */
String getFieldValue(String ref, Boolean doConvertVocabIds) {
  if (!doConvertVocabIds) {
    return getFieldValue(ref);
  }

  String val       = getFieldValue(ref);
  String vocabName = VOCABID_TO_VOCABNAME.get(val);

  if (val       == null) return "";
  if (vocabName == null) return "";
  return vocabName;
}

/* Shorthand for writing getFieldValue(ref, true). This function's use is
 * discouraged in favour of writing `getFieldValue(ref, true)`.
 */
String getMenuValue(String ref) {
  return getFieldValue(ref, true);
}

/******************************************************************************/
/*                                 ACTION BAR                                 */
/******************************************************************************/
addActionBarItem("clean_synced_files", new ActionButtonCallback() {
  actionOnLabel() {
    "{Clean_Synced_Files}";
  }
  actionOn() {
    cleanSyncedFiles();
  }
});

addActionBarItem("sync", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_Sync}";
  }
  actionOn() {
    setSyncEnabled(false);
    setFileSyncEnabled(false);
    showToast("{Sync_Disabled}");
  }
  isActionOff() {
    isSyncEnabled();
  }
  actionOffLabel() {
    "{Enable_Sync}";
  }
  actionOff() {
    setSyncEnabled(true);
    setFileSyncEnabled(true);
    showToast("{Sync_Enabled}");
  }
});

addActionBarItem("internal_gps", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_Internal_GPS}";
  }
  actionOn() {
    stopGPS();
    showToast("{Internal_GPS_Disabled}");
    updateGPSDiagnostics();
  }
  isActionOff() {
    isInternalGPSOn();
  }
  actionOffLabel() {
    "{Enable_Internal_GPS}";
  }
  actionOff() {
    if(isExternalGPSOn()) {
      stopGPS();
    }
    startInternalGPS();
    showToast("{Internal_GPS_Enabled}");
    updateGPSDiagnostics();
  }
});

addActionBarItem("external_gps", new ToggleActionButtonCallback() {
  actionOnLabel() {
    "{Disable_External_GPS}";
  }
  actionOn() {
    stopGPS();
    if (isBluetoothConnected()) {
      showToast("{External_GPS_Disabled}");
    } else {
      showToast("{Please_Enable_Bluetooth}");
    }
    updateGPSDiagnostics();
  }
  isActionOff() {
    isExternalGPSOn();
  }
  actionOffLabel() {
    "{Enable_External_GPS}";
  }
  actionOff() {
    if(isInternalGPSOn()) {
      stopGPS();
    }
    startExternalGPS();
    if(isBluetoothConnected()) {
      showToast("{External_GPS_Enabled}");
    } else {
      showToast("{Please_Enable_Bluetooth}");
      this.actionOn();
    }
    updateGPSDiagnostics();
  }
});

/******************************************************************************/
/*                                    GPS                                     */
/******************************************************************************/
addOnEvent("Control/Site/GPS_Diagnostics", "show", "updateGPSDiagnostics()");

void updateGPSDiagnostics() {
  String diagnosticsRef = "Control/Site/GPS_Diagnostics";
  if (diagnosticsRef.equals("")) {
    return;
  }

  String status         = "";
  String previousStatus = getFieldValue(diagnosticsRef);
  String notInitialised = "{GPS_is_not_initialised}";

  // Check if GPS is initialised or was previously initialised.
  if (!isExternalGPSOn() && !isInternalGPSOn()) {
    if (!isNull(previousStatus) && !previousStatus.equals(notInitialised)) { // previous gps status is some last valid coordinate.
      // This is hackish. Arch16n substitution happens only at display-time, but the following if clause requires substitution to have happened at run-time
      String error = "";
      error = "{GPS_is_no_longer_initialised}. {Previous_status}:";
      setFieldValue(diagnosticsRef, error);   // Arch16n entry is substituted after this
      error = getFieldValue(diagnosticsRef);

      // check that error message wasn't previously appended to the previous status message.
      if (previousStatus.length()    >= error.length() &&
          previousStatus.subSequence(0, error.length()).equals(error)) {
        status = previousStatus;
      } else {
        status = error + "\n" + previousStatus;
      }
    } else {
      status = notInitialised;
    }
  } else {
    status += "{Internal_GPS}: ";
    if (isInternalGPSOn())
    {
      status += "{on}";
    } else {
      status += "{off}";
    }
    status += "\nExternal GPS: ";
    if (isExternalGPSOn())
    {
      if (isBluetoothConnected()) {
        status += "{on_and_bluetooth_connected}";
      } else {
        status += "{on_and_bluetooth_disconnected}";
      }
    } else {
      status += "{off}";
    }
    Object position = getGPSPosition();
    if (position != null) {
      Object projPosition = getGPSPositionProjected();
      status += "\n{Latitude}: " + position.getLatitude();
      status += "   {Longitude}: " + position.getLongitude();
      status += "\n{Northing}: " + projPosition.getLatitude();
      status += "   {Easting}: " + projPosition.getLongitude();
      status += "\n{Accuracy}: " + getGPSEstimatedAccuracy();
    } else {
      status += "\n{Position}: {no_GPS_position_could_be_found}";
    }
  }
  setFieldValue(diagnosticsRef, status);
}

/******************************************************************************/
/*                                 USER LOGIN                                 */
/******************************************************************************/
{
  userId           = "1";
  String nameFirst = "";
  String nameLast  = "";
  String email     = "";

  User user = new User(userId, nameFirst, nameLast, email);
  setUser(user);
}

String userMenuPath = "User/User_List/Users";

void populateListForUsers(){
  String getNonDeletedUsersQuery = "SELECT userid, fname || ' ' || lname "+
                                   "  FROM user "+
                                   " WHERE userdeleted is null;";

  fetchAll(getNonDeletedUsersQuery, new FetchCallback() {
    onFetch(result) {
      populateDropDown(userMenuPath, result, true);
    }
  });
}

void selectUser() {
  String userVocabId = getFieldValue(userMenuPath);
  if (isNull(userVocabId)) {
    username = "";
    userid   = "";
    return;
  }

  String q = "";
  q += "SELECT userid, fname, lname, email, password";
  q += "  FROM user ";
  q += " WHERE userid = '{userId}'";
  q  = replaceFirst(q, "{userId}", userId);

  FetchCallback callback = new FetchCallback() {
    onFetch(result) {
      userId           = result.get(0);
      String nameFirst = result.get(1);
      String nameLast  = result.get(2);
      String email     = result.get(3);
      String password  = result.get(4);
      username         = nameFirst + " " + nameLast;

      User user = new User(userId, nameFirst, nameLast, email, password);
      setUser(user);
    }
  };

  fetchOne(q, callback);
}

addOnEvent(userMenuPath, "show",  "populateListForUsers()");
addOnEvent(userMenuPath, "click", "selectUser()");

/******************************************************************************/
/*                              MENU POPULATION                               */
/******************************************************************************/
/** Fetches the contents of a specifed vocabulary and stores it in the given list. **/
void fetchVocab(String vocabName, List storageList) {
  fetchVocab(vocabName, storageList, null);
}
void fetchVocab(String vocabName, List storageList, String callbackFunction) {
  fetchAll("select vocabid, vocabname from vocabulary left join attributekey using (attributeid) where attributename = '" + vocabName + "';", new FetchCallback() {
    onFetch(result) {
      storageList.addAll(result);
      Log.d("fetchVocab()", "Fetched vocabulary \"" + vocabname + "\" contents: " + result.toString());
      if (callbackFunction != null && !isNull(callbackFunction)) {
        execute(callbackFunction);
      }
    }
  });
}

/** Wrapper for to make a vocab without an exlusion list **/
void makeVocab(String type, String path, String attrib) {
  makeVocab(type, path, attrib, null);
}

/** Vocab Population **/
/* Populates the path specified vocabulary from the database based on the given attribute name, where type 
is the type of the vocab to populate (PictureGallery, HierarchicalPictureGallery, CheckBoxGroup, DropDown, HierarchicalDropDown, RadioGroup or List). */
void makeVocab(String type, String path, String attrib, List vocabExclusions) {
    makeVocab(type, path, attrib, vocabExclusions, null);
}

/* Populates the path specified vocabulary from the database based on the given attribute name, where type 
is the type of the vocab to populate (PictureGallery, HierarchicalPictureGallery, CheckBoxGroup, DropDown, HierarchicalDropDown, RadioGroup or List). */
void makeVocab(String type, String path, String attrib, List vocabExclusions, String callbackFunction){
  if (isNull(type) || isNull(path) || isNull(attrib)) {
    Log.e("makeVocab()", "Can't make populate a vocab when the given type, path or attribute is Null");
    return;
  }

  if (type.equals("PictureGallery")) {
    String pictureGalleryQuery = "SELECT vocabid, vocabname, pictureurl "+
                                 "  FROM vocabulary "+
                                 "  LEFT OUTER JOIN attributekey USING (attributeid) "+
                                 " WHERE attributename = '" + attrib + "' "+
                                 " ORDER BY  vocabcountorder;";
    fetchAll(pictureGalleryQuery, new FetchCallback() {
      onFetch(pictures) {
        populatePictureGallery(path, pictures);
        if (callbackFunction != null && !isNull(callbackFunction)) {
          execute(callbackFunction);
        }
      }
    });
    return;
  }

  if (type.equals("HierarchicalPictureGallery")) {
    populateHierarchicalPictureGallery(path, attrib);
    if (callbackFunction != null && !isNull(callbackFunction)) {
      execute(callbackFunction);
    }
    return;
  }

  if (type.equals("HierarchicalDropDown")) {
    // populateHierarchicalDropDown(path, attrib);
    populateHierarchicalDropDown(path, attrib, true);
    if (callbackFunction != null && !isNull(callbackFunction)) {
      execute(callbackFunction);
    }
    return;
  }

  String getAttributeVocabQuery = "SELECT vocabid, vocabname "+
                                  "  FROM vocabulary "+
                                  "  JOIN attributekey USING (attributeid) "+
                                  " WHERE attributename = '" + attrib + "' "+
                                  " ORDER BY vocabcountorder;";
  fetchAll(getAttributeVocabQuery,
    new FetchCallback() {
      onFetch(result) {
        // print("makeVocab() result: " + result);
        if (result!=null && result.size()>0 && vocabExclusions!=null && vocabExclusions.size()>0) {
          List filteredVocab = new ArrayList();
          for(item : result) {
            if (vocabExclusions.contains(item.get(1))) {
              Log.d("makeVocab()", "removing vocab exclusion: " + item.get(1));
            } else {
              filteredVocab.add(item);
            }
          }
          result=filteredVocab;
        }
        Boolean hasNull =
                vocabExclusions == null
            || !vocabExclusions.contains("")
            && !vocabExclusions.contains(null);
        // print("makeVocab() filtered result: " + result);
        if(type.equals("CheckBoxGroup")) {
          populateCheckBoxGroup(path, result);
        } else if(type.equals("DropDown")) {
          // populateDropDown(path, result);
          populateDropDown(path, result, hasNull);
        } else if(type.equals("RadioGroup")) {
          populateRadioGroup(path, result);
        } else if(type.equals("List")) {
          populateList(path, result);
        }
        if (callbackFunction != null && !isNull(callbackFunction)) {
          execute(callbackFunction);
        }
      }
    });
}

makeVocab("DropDown", "Site/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Trench/Trench/Trench_Dimensions", "Trench Dimensions");
makeVocab("CheckBoxGroup", "Trench/Trench/Excavation_Method", "Excavation Method");
makeVocab("List", "Trench/FCNs/List_of_Existing_FCNs", "List of Existing FCNs");
makeVocab("DropDown", "Trench/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Trench_Files/Add_Trench_Files/File_Type", "File Type");
makeVocab("DropDown", "Trench_Files/Vars/Device_Code", "Device Code");
makeVocab("CheckBoxGroup", "Locus/General/Excavation_Method", "Excavation Method");
makeVocab("DropDown", "Locus/General/Basal_Edge_Definition", "Basal Edge Definition");
makeVocab("DropDown", "Locus/General/Contamination", "Contamination");
makeVocab("PictureGallery", "Locus/General/Locus_Type", "Locus Type");
makeVocab("DropDown", "Locus/Cut/Cut_Your_Interpretation", "Cut Your Interpretation");
makeVocab("DropDown", "Locus/Cut/Shape_in_Plan", "Shape in Plan");
makeVocab("RadioGroup", "Locus/Cut/Shape_of_Corners", "Shape of Corners");
makeVocab("RadioGroup", "Locus/Cut/Break_of_Slope_-_Top", "Break of Slope - Top");
makeVocab("RadioGroup", "Locus/Cut/Break_of_Slope_-_Base", "Break of Slope - Base");
makeVocab("DropDown", "Locus/Cut/Sides_of_Cut", "Sides of Cut");
makeVocab("HierarchicalDropDown", "Locus/Cut/Shape_of_Base", "Shape of Base");
makeVocab("DropDown", "Locus/Cut/Orientation", "Orientation");
makeVocab("DropDown", "Locus/Cut/Inclination_of_axis", "Inclination of axis");
makeVocab("DropDown", "Locus/Deposit/Deposit_Your_Interpretation", "Deposit Your Interpretation");
makeVocab("DropDown", "Locus/Deposit/Texture", "Texture");
makeVocab("PictureGallery", "Locus/Deposit/Soil_Particle_Sorting", "Soil Particle Sorting");
makeVocab("DropDown", "Locus/Deposit/Material", "Material");
makeVocab("DropDown", "Locus/Deposit/Composition_Type", "Composition Type");
makeVocab("DropDown", "Locus/Deposit/Deposit_Bedding", "Deposit Bedding");
makeVocab("RadioGroup", "Locus/Deposit/Sterile", "Sterile");
makeVocab("HierarchicalDropDown", "Locus/Material_Helper/Material_Helper", "Material Helper");
makeVocab("DropDown", "Locus/Vars/Device_Code", "Device Code");
makeVocab("RadioGroup", "Stratum_Feature/General/Record_Type", "Record Type");
makeVocab("DropDown", "Stratum_Feature/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Stratum_Feature/Vars/Last_Feature_Type", "Last Feature Type");
makeVocab("DropDown", "Sediment_Aggregate/Sediment_Aggregate/Component_Type", "Component Type");
makeVocab("HierarchicalPictureGallery", "Sediment_Aggregate/Sediment_Aggregate/Soil_Stone_Shape", "Soil Stone Shape");
makeVocab("DropDown", "Sediment_Aggregate/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Photograph_Log/Photograph_Log/Scene_Type", "Scene Type");
makeVocab("DropDown", "Photograph_Log/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Diary/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "FCN/General/Collection_Method", "Collection Method");
makeVocab("HierarchicalDropDown", "FCN/General/FCN_Class", "FCN Class");
makeVocab("RadioGroup", "FCN/General/Washed", "Washed");
makeVocab("RadioGroup", "FCN/General/Weighted", "Weighted");
makeVocab("RadioGroup", "FCN/General/Analyzed", "Analyzed");
makeVocab("DropDown", "FCN/Vars/Device_Code", "Device Code");
makeVocab("HierarchicalDropDown", "Soil_Munsel_Color/Add_Soil_Munsel_Color/Soil_Munsel_Color", "Soil Munsel Color");
makeVocab("DropDown", "Soil_Munsel_Color/Vars/Device_Code", "Device Code");
makeVocab("DropDown", "Legacy/Var/Device_Code", "Device Code");
makeVocab("DropDown", "User/User_List/Device_Code", "Device Code");
makeVocab("DropDown", "Stratum_Feature/Vars/Last_Feature_Type", "Feature Type");

/******************************************************************************/
/*                                 VALIDATION                                 */
/******************************************************************************/
/* `ref`  is a reference/path to a field
 * `name` is a human-readable name for that field
 * `cond` is a String containing a boolean expression that evaluates to true if
 *        and only if the the field pair returned by this function should be
 *        validated.
 *
 *  Returns a field pair (really just an ArrayList).
 */
List fieldPair(String ref, String name, String cond) {
  List fp = new ArrayList();
  fp.add(ref);
  fp.add(name);
  fp.add(cond);
  return fp;
}

List fieldPair(String ref, String name) {
  String t = "true";
  return fieldPair(ref, name, t);
}

/* Returns true if field specified by `ref` is valid. False otherwise.
 */
boolean isValidField(String ref) {
  return !isNull(getFieldValue(ref));
}
/* `format` can either be HTML or PLAINTEXT
 */
String validateFields(List fields, String format) {
  Integer numInvalid = 0;

  /* Build validation message string (and count how many invalid fields exist) */
  String out = "Please fill out the following fields:\n";
  for(f : fields) {
    String ref  = f.get(0); // Reference to field
    String name = f.get(1); // Human-readable name
    String cond = f.get(2); // Validation condition

    // Only validate a field whose validation condition evaluates to `true`
    Boolean doValidateField = (Boolean) eval(cond);
    if (!doValidateField)
      continue;

    // Add any invalid fields to the output and tally them
    if (!isValidField(ref)) {
      out += "- " + name + "\n";
      numInvalid++;
    }
  }
  // All the fields are valid; just overwrite `out` with a cheery message
  if (numInvalid == 0)
    out = "All fields contain valid data!";

  /* Format the output as dictated by `format` */
  if (format == "HTML") {
    out = out.replace("\n", "<br>");
  } else if (format == "PLAINTEXT") {
    ;
  }

  return out;
}

void validateControl() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Control/Site/New_Site_Name", "{New_Site_Name}"));
  f.add(fieldPair("Control/Site/Year_of_Campaign", "{Year_of_Campaign}"));
  f.add(fieldPair("Control/Next_IDs/Next_Locus_Locus_ID", "{Locus_ID}"));
  f.add(fieldPair("Control/Next_IDs/Next_Stratum_Feature_ID", "{Stratum_Feature_ID}"));
  f.add(fieldPair("Control/Next_IDs/Next_FCN_ID", "{Next_FCN_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateSite() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Site/Site/Trench_ID", "{Trench_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateTrench() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Trench/Trench/Excavation_Method", "{Excavation_Method}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateLocus() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Locus/General/Locus_Site_Name", "{Site_Name}"));
  f.add(fieldPair("Locus/General/Locus_Locus_ID", "{Locus_ID}"));
  f.add(fieldPair("Locus/General/Excavation_Method", "{Excavation_Method}"));
  f.add(fieldPair("Locus/Measure/Absolute_Height_Top_m", "{Absolute_Height_Top__m_}"));
  f.add(fieldPair("Locus/Measure/Absolute_Height_Bottom_m", "{Absolute_Height_Bottom__m_}"));
  f.add(fieldPair("Locus/Measure/Measure_Length", "{Length__m_}"));
  f.add(fieldPair("Locus/Measure/Measure_Width", "{Width__m_}"));
  f.add(fieldPair("Locus/Measure/Measure_Depth", "{Depth__m_}"));
  f.add(fieldPair("Locus/Measure/Volume_Liters", "{Volume__liters_}"));
  f.add(fieldPair("Locus/Cut/Cut_Your_Interpretation", "{Your_Interpretation}"));
  f.add(fieldPair("Locus/Cut/Shape_in_Plan", "{Shape_in_Plan}"));
  f.add(fieldPair("Locus/Cut/Shape_of_Corners", "{Shape_of_Corners}"));
  f.add(fieldPair("Locus/Cut/Break_of_Slope_-_Top", "{Break_of_Slope___Top}"));
  f.add(fieldPair("Locus/Cut/Break_of_Slope_-_Base", "{Break_of_Slope___Base}"));
  f.add(fieldPair("Locus/Cut/Sides_of_Cut", "{Sides_of_Cut}"));
  f.add(fieldPair("Locus/Cut/Shape_of_Base", "{Shape_of_Base}"));
  f.add(fieldPair("Locus/Cut/Orientation", "{Orientation}"));
  f.add(fieldPair("Locus/Cut/Orientation_Degree", "{Orientation_Degree}"));
  f.add(fieldPair("Locus/Cut/Inclination_of_axis", "{Inclination_of_axis}"));
  f.add(fieldPair("Locus/Deposit/Deposit_Your_Interpretation", "{Your_Interpretation}"));
  f.add(fieldPair("Locus/Deposit/Texture", "{Texture}"));
  f.add(fieldPair("Locus/Deposit/Material", "{Material}"));
  f.add(fieldPair("Locus/Deposit/Composition_Type", "{Deposit_Structure}"));
  f.add(fieldPair("Locus/Deposit/Deposit_Bedding", "{Bedding}"));
  f.add(fieldPair("Locus/Deposit/Deposit_Inclusions", "{Deposit_Inclusions}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Head", "{Head}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Body", "{Body}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Left_Arm", "{Left_Arm_and_Hand_Location}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Right_Arm", "{Right_Arm_and_Hand_Location}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Left_Leg", "{Left_Leg_and_Foot_Location}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Right_Leg", "{Right_Leg_and_Foot_Location}"));
  f.add(fieldPair("Locus/Skeleton/Skeleton_Condition", "{Condition}"));
  f.add(fieldPair("Locus/Skeleton/Target_A_X", "{Target_A_X}"));
  f.add(fieldPair("Locus/Skeleton/Target_A_Y", "{Target_A_Y}"));
  f.add(fieldPair("Locus/Skeleton/Target_A_Z", "{Target_A_Z}"));
  f.add(fieldPair("Locus/Int/Your_description", "{Your_Description}"));
  f.add(fieldPair("Locus/Int/Your_Discussion", "{Your_Discussion}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateStratumFeature() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Stratum_Feature/General/Record_Type", "{Record_Type}"));
  f.add(fieldPair("Stratum_Feature/General/Feature_Prefix", "{Feature_Prefix}"));
  f.add(fieldPair("Stratum_Feature/General/Stratum_Feature_ID", "{Stratum_Feature_ID}"));
  f.add(fieldPair("Stratum_Feature/General/Description", "{Description}"));
  f.add(fieldPair("Stratum_Feature/General/Interpretation", "{Interpretation}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateRelationship() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Relationship/Relationships/Trench_ID", "{Trench_ID}"));
  f.add(fieldPair("Relationship/Relationships/Locus_ID", "{Locus_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateStratumFeatureRelationship() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Stratum_Feature_Relationship/Relationships/Trench_ID", "{Trench_ID}"));
  f.add(fieldPair("Stratum_Feature_Relationship/Relationships/Locus_ID", "{Locus_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateFCN() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("FCN/General/FCN_ID", "{FCN_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}
void validateLegacy() {
  List f = new ArrayList(); // Fields to be validated
  f.add(fieldPair("Legacy/Legacy/Legacy_Year_of_Campaign", "{Year_of_Campaign}"));
  f.add(fieldPair("Legacy/Legacy/Legacy_Trench_ID", "{Trench_ID}"));
  f.add(fieldPair("Legacy/Legacy/Legacy_Locus_ID", "{Locus_ID}"));

  String validationMessage = validateFields(f, "PLAINTEXT");
  showWarning("Validation Results", validationMessage);
}


/******************************************************************************/
/*                                 AUTOSAVING                                 */
/******************************************************************************/
Map tabgroupToUuid = Collections.synchronizedMap(new HashMap());

String getUuid(String tabgroup) {
  return tabgroupToUuid.get(tabgroup);
}

void setUuid(String tabgroup, String uuid) {
  tabgroupToUuid.put(tabgroup, uuid);
}

void saveTabGroup(String tabgroup) {
  saveTabGroup(tabgroup, "");
}

void saveTabGroup(String tabgroup, String callback) {
  Boolean enableAutosave      = true;
  String  id                  = getUuid(tabgroup);
  List    geometry            = null;
  List    attributes          = null;
  String  parentTabgroup_     = parentTabgroup;
  String  parentTabgroupUuid_ = getUuid(parentTabgroup_);
  Boolean userWasSet          = !username.equals("");

  callback += "; onSave" + getArchEntTypePascalCased(tabgroup) + "__()";

  parentTabgroup = null;

  SaveCallback saveCallback  = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);
      // Make a child-parent relationship if need be.
      if (
          newRecord &&
          !isNull(parentTabgroup_) &&
          !isNull(parentTabgroupUuid_)
      ) {
        String rel = "";
        rel += parentTabgroup_.replaceAll("_", " ");
        rel += " - ";
        rel += tabgroup.replaceAll("_", " ");
        saveEntitiesToHierRel(
          rel,
          parentTabgroupUuid_,
          uuid,
          "Parent Of",
          "Child Of",
          callback
        );
      } else {
        execute(callback);
      }

      // This fixes an interesting bug. Without this, if a user was not set
      // (by calling `setUser`) at the time `saveTabGroup` was first called, but
      // set by the time `onSave` was called, the tab group is saved correctly
      // the first time only.
      //
      // Adding this allows subsequent saves to succeed. Presumably it plays
      // some role in helping FAIMS associate the correct user with a record.
      if (!userWasSet) {
        saveTabGroup(tabgroup, callback);
      }

    }
    onError(message) {
      showToast(message);
    }
  };

  saveTabGroup(tabgroup, id, geometry, attributes, saveCallback, enableAutosave);
}

void setToTimestampNow(String ref) {
  String now = getTimestampNow();
  setFieldValue(ref, now);
}

String getTimestampNow() {
  String fmt = "yyyy-MM-dd HH:mm:ssZ";
  return getTimestampNow(fmt);
}

String getTimestampNow(String fmt) {
  date    = new Date();
  dateFmt = new java.text.SimpleDateFormat(fmt);
  dateStr = dateFmt.format(date);

  // Insert colon into timezone (e.g. +1000 -> +10:00)
  String left; String right;

  left    = dateStr.substring(0, dateStr.length() - 2);
  right   = dateStr.substring(   dateStr.length() - 2);
  dateStr = left + ":" + right;

  return dateStr;
}

void populateAuthorAndTimestamp(String tabgroup) {
  Map tabgroupToAuthor    = new HashMap();
  Map tabgroupToTimestamp = new HashMap();
  tabgroupToAuthor.put("Trench", "Trench/Trench/Trench_author");
  tabgroupToAuthor.put("Trench_Files", "Trench_Files/Add_Trench_Files/Trench_Files_author");
  tabgroupToAuthor.put("Locus", "Locus/General/Locus_author");
  tabgroupToAuthor.put("Stratum_Feature", "Stratum_Feature/General/Stratum_Feature_author");
  tabgroupToAuthor.put("Diary", "Diary/Diary/Diary_author");
  tabgroupToTimestamp.put("Trench", "Trench/Trench/Trench_timestamp");
  tabgroupToTimestamp.put("Locus", "Locus/General/Locus_timestamp");
  tabgroupToTimestamp.put("Stratum_Feature", "Stratum_Feature/General/Stratum_Feature_timestamp");
  String authorPath    = tabgroupToAuthor.get(tabgroup);
  String timestampPath = tabgroupToTimestamp.get(tabgroup);

  String authorVal    = username;
  String timestampVal = getTimestampNow();

  if (!isNull(authorPath))    setFieldValue(authorPath,    authorVal);
  if (!isNull(timestampPath)) setFieldValue(timestampPath, timestampVal);
}

void onShowSite () {
  saveTabGroup("Site");
}

void onShowTrench () {
  saveTabGroup("Trench");
}

void onShowTrenchFiles () {
  saveTabGroup("Trench_Files");
}

void onShowLocus () {
  saveTabGroup("Locus");
}

void onShowStratumFeature () {
  saveTabGroup("Stratum_Feature");
}

void onShowSedimentAggregate () {
  saveTabGroup("Sediment_Aggregate");
}

void onShowPhotographLog () {
  saveTabGroup("Photograph_Log");
}

void onShowDiary () {
  saveTabGroup("Diary");
}

void onShowFCN () {
  saveTabGroup("FCN");
}

void onShowSoilMunselColor () {
  saveTabGroup("Soil_Munsel_Color");
}

void onShowLegacy () {
  saveTabGroup("Legacy");
}

addOnEvent("Site", "show", "onShowSite()");
addOnEvent("Trench", "show", "onShowTrench()");
addOnEvent("Trench_Files", "show", "onShowTrenchFiles()");
addOnEvent("Locus", "show", "onShowLocus()");
addOnEvent("Stratum_Feature", "show", "onShowStratumFeature()");
addOnEvent("Sediment_Aggregate", "show", "onShowSedimentAggregate()");
addOnEvent("Photograph_Log", "show", "onShowPhotographLog()");
addOnEvent("Diary", "show", "onShowDiary()");
addOnEvent("FCN", "show", "onShowFCN()");
addOnEvent("Soil_Munsel_Color", "show", "onShowSoilMunselColor()");
addOnEvent("Legacy", "show", "onShowLegacy()");

void onClickUserUserListLogin () {
  newTab("Control", true);
}

void onClickUserUserListModuleGuide () {
  newTab("User/Help", true);
}

void onClickTrenchTrenchSetDateClosed () {
  newTab("Date_Closed", true);
}

void onClickLocusDepositMaterialHelper () {
  newTab("Locus/Material_Helper", true);
}

void onClickLocusRelationshipsCreateRelationshipstoThisLocus () {
  newTab("Relationship", true);
}

void onClickStratumFeatureStratumFeatureLociCreateRelationshipstoThisStratumFeature () {
  newTab("Stratum_Feature_Relationship", true);
}

void onClickControlSiteCreateNewSite () {
  parentTabgroup__ = "Control";
  newSite();
}

void onClickRelationshipLegaciesCreateNewLegacy () {
  parentTabgroup__ = "Relationship";
  newLegacy();
}

void onClickStratumFeatureRelationshipLegaciesCreateNewLegacy () {
  parentTabgroup__ = "Stratum_Feature_Relationship";
  newLegacy();
}

void onClickSiteSiteTrenches () {
  String tabgroup = "Site";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newTrench();
}

void onClickTrenchTrenchAddTrenchFiles () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newTrenchFiles();
}

void onClickTrenchLociCreateNewLocus () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newLocus();
}

void onClickTrenchStrataFeaturesCreateNewStratumFeature () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newStratumFeature();
}

void onClickTrenchFCNsCreateNewFCN () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newFCN();
}

void onClickTrenchDiariesCreateNewDiary () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newDiary();
}

void onClickTrenchLegaciesCreateNewLegacy () {
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newLegacy();
}

void onClickLocusDepositAddMunselColor () {
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newSoilMunselColor();
}

void onClickLocusDepositAddNewSedimentAggregate () {
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newSedimentAggregate();
}

void onClickLocusFCNsAddFCN () {
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newFCN();
}

void onClickLocusAddAddPhotographLog () {
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newPhotographLog();
}

void onClickStratumFeatureAddAddPhotographLog () {
  String tabgroup = "Stratum_Feature";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  newPhotographLog();
}
addOnEvent("User/User_List/Login", "click", "onClickUserUserListLogin()");
addOnEvent("User/User_List/Module_Guide", "click", "onClickUserUserListModuleGuide()");
addOnEvent("Trench/Trench/Set_Date_Closed", "click", "onClickTrenchTrenchSetDateClosed()");
addOnEvent("Locus/Deposit/Material_Helper", "click", "onClickLocusDepositMaterialHelper()");
addOnEvent("Locus/Relationships/Create_Relationships_to_This_Locus", "click", "onClickLocusRelationshipsCreateRelationshipstoThisLocus()");
addOnEvent("Stratum_Feature/Stratum_Feature_Loci/Create_Relationships_to_This_Stratum_Feature", "click", "onClickStratumFeatureStratumFeatureLociCreateRelationshipstoThisStratumFeature()");
addOnEvent("Control/Site/Create_New_Site", "click", "onClickControlSiteCreateNewSite()");
addOnEvent("Relationship/Legacies/Create_New_Legacy", "click", "onClickRelationshipLegaciesCreateNewLegacy()");
addOnEvent("Stratum_Feature_Relationship/Legacies/Create_New_Legacy", "click", "onClickStratumFeatureRelationshipLegaciesCreateNewLegacy()");
addOnEvent("Site/Site/Trenches", "click", "onClickSiteSiteTrenches()");
addOnEvent("Trench/Trench/Add_Trench_Files", "click", "onClickTrenchTrenchAddTrenchFiles()");
addOnEvent("Trench/Loci/Create_New_Locus", "click", "onClickTrenchLociCreateNewLocus()");
addOnEvent("Trench/Strata_Features/Create_New_Stratum_Feature", "click", "onClickTrenchStrataFeaturesCreateNewStratumFeature()");
addOnEvent("Trench/FCNs/Create_New_FCN", "click", "onClickTrenchFCNsCreateNewFCN()");
addOnEvent("Trench/Diaries/Create_New_Diary", "click", "onClickTrenchDiariesCreateNewDiary()");
addOnEvent("Trench/Legacies/Create_New_Legacy", "click", "onClickTrenchLegaciesCreateNewLegacy()");
addOnEvent("Locus/Deposit/Add_Munsel_Color", "click", "onClickLocusDepositAddMunselColor()");
addOnEvent("Locus/Deposit/Add_New_Sediment_Aggregate", "click", "onClickLocusDepositAddNewSedimentAggregate()");
addOnEvent("Locus/FCNs/Add_FCN", "click", "onClickLocusFCNsAddFCN()");
addOnEvent("Locus/Add/Add_Photograph_Log", "click", "onClickLocusAddAddPhotographLog()");
addOnEvent("Stratum_Feature/Add/Add_Photograph_Log", "click", "onClickStratumFeatureAddAddPhotographLog()");

/******************************************************************************/
/*                   AUDIO, CAMERA, FILE AND VIDEO BINDINGS                   */
/******************************************************************************/

addOnEvent("Trench_Files/Add_Trench_Files/Add_Photo_Button_1", "click", "attachPictureTo(\"Trench_Files/Add_Trench_Files/Add_Photo\")");
addOnEvent("Locus/General/Photo_of_Plan_Button_1", "click", "attachPictureTo(\"Locus/General/Photo_of_Plan\")");
addOnEvent("Locus/General/Photo_of_Section_Button_1", "click", "attachPictureTo(\"Locus/General/Photo_of_Section\")");
addOnEvent("Locus/Add/Photo_Button_1", "click", "attachPictureTo(\"Locus/Add/Photo\")");
addOnEvent("Stratum_Feature/Add/Photo_Button_1", "click", "attachPictureTo(\"Stratum_Feature/Add/Photo\")");
addOnEvent("Diary/Diary/Photo_Button_1", "click", "attachPictureTo(\"Diary/Diary/Photo\")");
addOnEvent("FCN/General/Attach_Photograph_Button_1", "click", "attachPictureTo(\"FCN/General/Attach_Photograph\")");
addOnEvent("Trench_Files/Add_Trench_Files/Attach_File_Button_1", "click", "attachFileTo(\"Trench_Files/Add_Trench_Files/Attach_File\")");
addOnEvent("Locus/Add/Attach_File_Button_1", "click", "attachFileTo(\"Locus/Add/Attach_File\")");
addOnEvent("Stratum_Feature/Add/Attach_File_Button_1", "click", "attachFileTo(\"Stratum_Feature/Add/Attach_File\")");
addOnEvent("FCN/General/Attach_File_Button_1", "click", "attachFileTo(\"FCN/General/Attach_File\")");


/******************************************************************************/
/*                 BINDINGS FOR 'VIEW ATTACHED FILES' BUTTONS                 */
/******************************************************************************/
addOnEvent("Trench_Files/Add_Trench_Files/View_Attached_Files", "click", "viewArchEntAttachedFiles(getUuid(\"Trench_Files\"))");
addOnEvent("Locus/Add/View_Attached_Files", "click", "viewArchEntAttachedFiles(getUuid(\"Locus\"))");
addOnEvent("Stratum_Feature/Add/View_Attached_Files", "click", "viewArchEntAttachedFiles(getUuid(\"Stratum_Feature\"))");
addOnEvent("FCN/General/View_Attached_Files", "click", "viewArchEntAttachedFiles(getUuid(\"FCN\"))");

/******************************************************************************/
/*                             NAVIGATION DRAWER                              */
/******************************************************************************/
void removeNavigationButtons() {
  removeNavigationButton("new");
  removeNavigationButton("duplicate");
  removeNavigationButton("delete");
  removeNavigationButton("validate");
}

void addNavigationButtons(String tabgroup) {
  removeNavigationButtons();
  List tabgroupsToValidate = new ArrayList();
  tabgroupsToValidate.add("Control");
  tabgroupsToValidate.add("Relationship");
  tabgroupsToValidate.add("Stratum_Feature");
  tabgroupsToValidate.add("Site");
  tabgroupsToValidate.add("Locus");
  tabgroupsToValidate.add("Trench");
  tabgroupsToValidate.add("Stratum_Feature_Relationship");
  tabgroupsToValidate.add("Legacy");
  tabgroupsToValidate.add("FCN");
  addNavigationButton("new", new ActionButtonCallback() {
    actionOnLabel() {
      "{New}";
    }
    actionOn() {
      if(isNull(getUuid(tabgroup))) {
        showAlert(
            "{Warning}",
            "{The_current_record_has_not_been_saved_yet}",
            fun2str("newRecord", new Object[]{tabgroup, true}),
            ""
        );
      } else {
        newRecord(tabgroup, true);
        showToast("{New_record_created}");
      }
    }
  }, "success");
  addNavigationButton("duplicate", new ActionButtonCallback() {
    actionOnLabel() {
      "{Duplicate}";
    }
    actionOn() {
      if(!isNull(getUuid(tabgroup))) {
        duplicateRecord(tabgroup);
      } else {
        showWarning("{Warning}", "{This_record_is_unsaved_and_cannot_be_duplicated}");
      }
    }
  }, "primary");
  addNavigationButton("delete", new ActionButtonCallback() {
    actionOnLabel() {
      "{Delete}";
    }
    actionOn() {
      deleteRecord(tabgroup);
    }
  }, "danger");
  if (tabgroupsToValidate.contains(tabgroup)) {
    addNavigationButton("validate", new ActionButtonCallback() {
      actionOnLabel() {
        "{Validate}";
      }
      actionOn() {
        String validationFunction = "validate" + tabgroup.replaceAll("_", "") + "()";
        eval(validationFunction);
      }
    }, "default");
  }
}

/******************************************************************************/
/*        ENTITY AND RELATIONSHIP SAVING AND LOADING HELPER FUNCTIONS         */
/******************************************************************************/
/** Saves two entity id's as a relation. **/
void saveEntitiesToRel(String type, String entity1, String entity2) {
  String callback = null;
  saveEntitiesToRel(type, entity1, entity2, callback);
}

/** Saves two entity id's as a relation with some callback executed. **/
void saveEntitiesToRel(String type, String entity1, String entity2, String callback) {
  String e1verb = null;
  String e2verb = null;
  saveEntitiesToHierRel(type, entity1, entity2, e1verb, e2verb, callback);
}

/** Saves two entity id's as a hierachical relation with some callback executed. **/
void saveEntitiesToHierRel(String type, String entity1, String entity2, String e1verb, String e2verb, String callback) {
  if (isNull(entity1) || isNull(entity2)) return;
  saveRel(null, type, null, null, new SaveCallback() {
    onSave(rel_id, newRecord) {
      addReln(entity1, rel_id, e1verb);
      addReln(entity2, rel_id, e2verb);
      if(!isNull(callback)) {
         execute(callback);
      }
    }
    onError(message) {
      Log.e("saveEntitiesToHierRel", message);
      showToast(message);
    }
  });
}

// Makes a new record of the given tabgroup
void newRecord(String tabgroup) {
  boolean doUpdateRelVars = false;
  newRecord(tabgroup, doUpdateRelVars);
}

void newRecord(String tabgroup, boolean doUpdateRelVars) {
  if (doUpdateRelVars) {
    String uuidOld = getUuid(getDisplayedTabGroup());
    String q       = getDuplicateRelnQuery(uuidOld); // We're not duplicating
                                                     // anything, just getting
                                                     // the parent's UUID.

    cancelTabGroup(tabgroup, false);

    FetchCallback updateRelVars = new FetchCallback() {
      onFetch(result) {
        if (result != null && result.size() >= 1) {
          parentTabgroup   = result.get(0).get(4);
          parentTabgroup   = parentTabgroup.replaceAll(" ", "_");
          parentTabgroup__ = parentTabgroup;
        }

        newRecord(tabgroup, false);
      }
    };
    fetchAll(q, updateRelVars);
    return;
  }

  String newTabGroupFunction = "new" + tabgroup.replaceAll("_", "") + "()"; // Typical value: "newTabgroup()"
  eval(newTabGroupFunction);

  Log.d("newRecord", tabgroup);
}

// Deletes the current record of the given tabgroup
void deleteRecord(String tabgroup) {
  String deleteTabGroupFunction = "delete" + tabgroup.replaceAll("_", "") + "()"; // Typical value: "deleteTabgroup()"
  eval(deleteTabGroupFunction);

  Log.d("deleteRecord", tabgroup);
}

// Duplicates the current record of the given tabgroup
void duplicateRecord(String tabgroup) {
  dialog = showBusy("Duplicating", "Please wait...");

  String duplicateTabGroupFunction = "duplicate" + tabgroup.replaceAll("_", "") + "()"; // Typical value: "duplicateTabgroup()"
  eval(duplicateTabGroupFunction);

  Log.d("duplicateRecord", tabgroup);
}

// generic fetch saved attributes query
String getDuplicateAttributeQuery(String originalRecordID, String attributesToDupe) {
  if (attributesToDupe.equals("")) {
    attributesToDupe = "''";
  }
  String duplicateQuery = "SELECT attributename, freetext, vocabid, measure, certainty " +
                          "  FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) " +
                          " WHERE attributename IN ('', "+attributesToDupe+") " +
                          "   AND uuid = '"+originalRecordID+"'; ";
  return duplicateQuery;
}

String getDuplicateRelnQuery(String originalRecordID) {
  String dupeRelnQuery = "SELECT relntypename, parentparticipatesverb, childparticipatesverb, parentuuid, parentaenttypename, childaenttypename"+
                         "  FROM parentchild join relationship using (relationshipid) "+
                         "  JOIN relntype using (relntypeid) "+
                         " WHERE childuuid = '"+originalRecordID+"' " +
                         "   AND parentparticipatesverb = 'Parent Of' ";
  return dupeRelnQuery;
}

void makeDuplicateRelationships(fetchedAttributes, String newUuid){
  Log.e("Module", "makeDuplicateRelationships");
  for (savedAttribute : fetchedAttributes){
    String relntypename           = savedAttribute.get(0);
    String parentparticipatesverb = savedAttribute.get(1);
    String childparticipatesverb  = savedAttribute.get(2);
    String parentUuid             = savedAttribute.get(3);
    String childArchEntType       = savedAttribute.get(5);

    String onSaveRel              = "onSave" + childArchEntType.replaceAll(" ", "") + "__()";

    saveEntitiesToHierRel(
        relntypename,
        parentUuid,
        newUuid,
        parentparticipatesverb,
        childparticipatesverb,
        onSaveRel
    );
  }
}

// generic get extra attributes
List getExtraAttributes(fetchedAttributes) {
  List extraAttributes = createAttributeList();
  Log.d("Module", "Duplicating fetched attributes: " + fetchedAttributes.toString());
  for (savedAttribute : fetchedAttributes) {
    extraAttributes.add(
      createEntityAttribute(
        savedAttribute.get(0),
        savedAttribute.get(1),
        savedAttribute.get(2),
        savedAttribute.get(3),
        savedAttribute.get(4)
      )
    );
  }
  return extraAttributes;
}

void loadEntity() {
  loadEntity(false);
}
void loadEntity(Boolean isDropdown) {
  if (isDropdown) {
    loadEntityFrom(getDropdownItemValue());
  } else {
    loadEntityFrom(getListItemValue());
  }
}

void loadEntityFrom(String entityID) {
  if (isNull(entityID)) {
    return;
  }

  String getEntTypeNameQ = "SELECT aenttypename " +
                           "  FROM latestnondeletedarchent " +
                           "  JOIN aenttype " +
                           " USING (aenttypeid) " +
                           " WHERE uuid = '" + entityID + "'";
  fetchAll(getEntTypeNameQ, new FetchCallback() {
    onFetch(result) {
      if (
          result               == null ||
          result       .size() == 0    ||
          result.get(0).size() == 0
      ) {
        String head;
        String body;

        head  = "Record Could Not Be Loaded";
        body  = "The record could not be loaded. It may have been deleted by";
        body += " another user.";

        showWarning(head, body);
        return;
      }

      String archEntName = result.get(0).get(0).replaceAll(" ", "");
      String loadFunction = "load" + archEntName + "From(entityID)"; // Typical value: loadContextFrom(entityID)
      eval(loadFunction);
    }
  });
}

void newSite (){
  String tabgroup = "Site";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateSite__();
}
void newTrench (){
  String tabgroup = "Trench";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateTrench__();
}
void newTrenchFiles (){
  String tabgroup = "Trench_Files";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateTrenchFiles__();
}
void newLocus (){
  String tabgroup = "Locus";
  if (isNull("Control/Next_IDs/Next_Locus_Locus_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Locus/General/Locus_Locus_ID");

  onCreateLocus__();
}
void newStratumFeature (){
  String tabgroup = "Stratum_Feature";
  if (isNull("Control/Next_IDs/Next_Stratum_Feature_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("Stratum_Feature/General/Stratum_Feature_ID");

  onCreateStratumFeature__();
}
void newSedimentAggregate (){
  String tabgroup = "Sediment_Aggregate";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateSedimentAggregate__();
}
void newPhotographLog (){
  String tabgroup = "Photograph_Log";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreatePhotographLog__();
}
void newDiary (){
  String tabgroup = "Diary";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateDiary__();
}
void newFCN (){
  String tabgroup = "FCN";
  if (isNull("Control/Next_IDs/Next_FCN_ID")) {
    showWarning("{Alert}", "{A_next_ID_has_not_been_entered_please_provide_one}");
    return;
  }

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  incAutoNum("FCN/General/FCN_ID");

  onCreateFCN__();
}
void newSoilMunselColor (){
  String tabgroup = "Soil_Munsel_Color";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateSoilMunselColor__();
}
void newLegacy (){
  String tabgroup = "Legacy";
  

  setUuid(tabgroup, null);
  newTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  

  onCreateLegacy__();
}
void onCreateSite__(){
  String ref      = "Site";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateTrench__(){
  String ref      = "Trench";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateLocus__(){
  String ref      = "Locus";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateSedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreatePhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateDiary__(){
  String ref      = "Diary";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateFCN__(){
  String ref      = "FCN";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateSoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCreateLegacy__(){
  String ref      = "Legacy";
  String event    = "create";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchSite__(){
  String ref      = "Site";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchTrench__(){
  String ref      = "Trench";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchLocus__(){
  String ref      = "Locus";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchSedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchPhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchDiary__(){
  String ref      = "Diary";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchFCN__(){
  String ref      = "FCN";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchSoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onPrefetchLegacy__(){
  String ref      = "Legacy";
  String event    = "prefetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchSite__(){
  String ref      = "Site";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchTrench__(){
  String ref      = "Trench";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchLocus__(){
  String ref      = "Locus";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchSedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchPhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchDiary__(){
  String ref      = "Diary";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchFCN__(){
  String ref      = "FCN";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchSoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onFetchLegacy__(){
  String ref      = "Legacy";
  String event    = "fetch";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveSite__(){
  String ref      = "Site";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveTrench__(){
  String ref      = "Trench";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveLocus__(){
  String ref      = "Locus";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveSedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSavePhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveDiary__(){
  String ref      = "Diary";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveFCN__(){
  String ref      = "FCN";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveSoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onSaveLegacy__(){
  String ref      = "Legacy";
  String event    = "save";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopySite__(){
  String ref      = "Site";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyTrench__(){
  String ref      = "Trench";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyLocus__(){
  String ref      = "Locus";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopySedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyPhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyDiary__(){
  String ref      = "Diary";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyFCN__(){
  String ref      = "FCN";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopySoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onCopyLegacy__(){
  String ref      = "Legacy";
  String event    = "copy";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteSite__(){
  String ref      = "Site";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteTrench__(){
  String ref      = "Trench";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteTrenchFiles__(){
  String ref      = "Trench_Files";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteLocus__(){
  String ref      = "Locus";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteStratumFeature__(){
  String ref      = "Stratum_Feature";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteSedimentAggregate__(){
  String ref      = "Sediment_Aggregate";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeletePhotographLog__(){
  String ref      = "Photograph_Log";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteDiary__(){
  String ref      = "Diary";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteFCN__(){
  String ref      = "FCN";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteSoilMunselColor__(){
  String ref      = "Soil_Munsel_Color";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void onDeleteLegacy__(){
  String ref      = "Legacy";
  String event    = "delete";
  String stmtsStr = getStatementsString(ref, event);
  execute(stmtsStr);
}
void duplicateSite(){
  String tabgroup = "Site";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopySite__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateTrench(){
  String tabgroup = "Trench";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopyTrench__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateTrenchFiles(){
  String tabgroup = "Trench_Files";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Trench_Files/Add_Trench_Files/Add_Photo", new ArrayList());
  populateFileList("Trench_Files/Add_Trench_Files/Attach_File", new ArrayList());
  onCopyTrenchFiles__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Add Photo");
      excludeAttributes.add("Attach File");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateLocus(){
  String tabgroup = "Locus";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Locus/General/Locus_Locus_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Locus/General/Photo_of_Plan", new ArrayList());
  populateCameraPictureGallery("Locus/General/Photo_of_Section", new ArrayList());
  populateCameraPictureGallery("Locus/Add/Photo", new ArrayList());
  populateFileList("Locus/Add/Attach_File", new ArrayList());
  onCopyLocus__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Photo of Plan");
      excludeAttributes.add("Photo of Section");
      excludeAttributes.add("Photo");
      excludeAttributes.add("Attach File");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateStratumFeature(){
  String tabgroup = "Stratum_Feature";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("Stratum_Feature/General/Stratum_Feature_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Stratum_Feature/Add/Photo", new ArrayList());
  populateFileList("Stratum_Feature/Add/Attach_File", new ArrayList());
  onCopyStratumFeature__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Photo");
      excludeAttributes.add("Attach File");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateSedimentAggregate(){
  String tabgroup = "Sediment_Aggregate";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopySedimentAggregate__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicatePhotographLog(){
  String tabgroup = "Photograph_Log";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopyPhotographLog__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateDiary(){
  String tabgroup = "Diary";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateCameraPictureGallery("Diary/Diary/Photo", new ArrayList());
  onCopyDiary__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Photo");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateFCN(){
  String tabgroup = "FCN";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  incAutoNum("FCN/General/FCN_ID");
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  populateFileList("FCN/General/Attach_File", new ArrayList());
  populateCameraPictureGallery("FCN/General/Attach_Photograph", new ArrayList());
  onCopyFCN__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      excludeAttributes.add("Attach File");
      excludeAttributes.add("Attach Photograph");

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateSoilMunselColor(){
  String tabgroup = "Soil_Munsel_Color";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopySoilMunselColor__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void duplicateLegacy(){
  String tabgroup = "Legacy";
  String uuidOld = getUuid(tabgroup);
  setUuid(tabgroup, "");
  disableAutoSave(tabgroup);
  
  clearGpsInTabGroup(tabgroup);
  populateAuthorAndTimestamp(tabgroup);
  populateEntityListsInTabGroup(tabgroup);
  
  onCopyLegacy__();

  saveCallback = new SaveCallback() {
    onSave(uuid, newRecord) {
      setUuid(tabgroup, uuid);

      fetchAll(getDuplicateRelnQuery(uuidOld), new FetchCallback(){
        onFetch(result) {
          Log.e("Module", result.toString());

          if (result != null && result.size() >= 1) {
            parentTabgroup__ = result.get(0).get(4);
            parentTabgroup__ = parentTabgroup__.replaceAll(" ", "_");
          }

          makeDuplicateRelationships(result, getUuid(tabgroup));

          showToast("{Duplicated_record}");
          dialog.dismiss();
        }
      });

      saveTabGroup(tabgroup);
    }
  };

  String extraDupeAttributes = "";
  fetchAll(getDuplicateAttributeQuery(uuidOld, extraDupeAttributes), new FetchCallback(){
    onFetch(result) {
      excludeAttributes = new ArrayList();

      

      duplicateTabGroup(tabgroup, null, getExtraAttributes(result), excludeAttributes, saveCallback);
    }
  });
}
void deleteSite(){
  String tabgroup = "Site";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteSite()", "doNotDelete()");
  }
}
void deleteTrench(){
  String tabgroup = "Trench";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteTrench()", "doNotDelete()");
  }
}
void deleteTrenchFiles(){
  String tabgroup = "Trench_Files";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteTrenchFiles()", "doNotDelete()");
  }
}
void deleteLocus(){
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteLocus()", "doNotDelete()");
  }
}
void deleteStratumFeature(){
  String tabgroup = "Stratum_Feature";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteStratumFeature()", "doNotDelete()");
  }
}
void deleteSedimentAggregate(){
  String tabgroup = "Sediment_Aggregate";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteSedimentAggregate()", "doNotDelete()");
  }
}
void deletePhotographLog(){
  String tabgroup = "Photograph_Log";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeletePhotographLog()", "doNotDelete()");
  }
}
void deleteDiary(){
  String tabgroup = "Diary";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteDiary()", "doNotDelete()");
  }
}
void deleteFCN(){
  String tabgroup = "FCN";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteFCN()", "doNotDelete()");
  }
}
void deleteSoilMunselColor(){
  String tabgroup = "Soil_Munsel_Color";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteSoilMunselColor()", "doNotDelete()");
  }
}
void deleteLegacy(){
  String tabgroup = "Legacy";
  if (isNull(getUuid(tabgroup))) {
    cancelTabGroup(tabgroup, true);
  } else {
    showAlert("{Confirm_Deletion}", "{Press_OK_to_Delete_this_Record}", "reallyDeleteLegacy()", "doNotDelete()");
  }
}
void reallyDeleteSite (){
  String tabgroup = "Site";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteSite__();
}
void reallyDeleteTrench (){
  String tabgroup = "Trench";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteTrench__();
}
void reallyDeleteTrenchFiles (){
  String tabgroup = "Trench_Files";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteTrenchFiles__();
}
void reallyDeleteLocus (){
  String tabgroup = "Locus";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteLocus__();
}
void reallyDeleteStratumFeature (){
  String tabgroup = "Stratum_Feature";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteStratumFeature__();
}
void reallyDeleteSedimentAggregate (){
  String tabgroup = "Sediment_Aggregate";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteSedimentAggregate__();
}
void reallyDeletePhotographLog (){
  String tabgroup = "Photograph_Log";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeletePhotographLog__();
}
void reallyDeleteDiary (){
  String tabgroup = "Diary";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteDiary__();
}
void reallyDeleteFCN (){
  String tabgroup = "FCN";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteFCN__();
}
void reallyDeleteSoilMunselColor (){
  String tabgroup = "Soil_Munsel_Color";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteSoilMunselColor__();
}
void reallyDeleteLegacy (){
  String tabgroup = "Legacy";

  deleteArchEnt(getUuid(tabgroup));
  cancelTabGroup(tabgroup, false);
  populateEntityListsOfArchEnt(tabgroup);
  onDeleteLegacy__();
}
addOnEvent("Site", "save", "populateEntityListsOfArchEnt(\"Site\")");
addOnEvent("Trench", "save", "populateEntityListsOfArchEnt(\"Trench\")");
addOnEvent("Trench_Files", "save", "populateEntityListsOfArchEnt(\"Trench_Files\")");
addOnEvent("Locus", "save", "populateEntityListsOfArchEnt(\"Locus\")");
addOnEvent("Stratum_Feature", "save", "populateEntityListsOfArchEnt(\"Stratum_Feature\")");
addOnEvent("Sediment_Aggregate", "save", "populateEntityListsOfArchEnt(\"Sediment_Aggregate\")");
addOnEvent("Photograph_Log", "save", "populateEntityListsOfArchEnt(\"Photograph_Log\")");
addOnEvent("Diary", "save", "populateEntityListsOfArchEnt(\"Diary\")");
addOnEvent("FCN", "save", "populateEntityListsOfArchEnt(\"FCN\")");
addOnEvent("Soil_Munsel_Color", "save", "populateEntityListsOfArchEnt(\"Soil_Munsel_Color\")");
addOnEvent("Legacy", "save", "populateEntityListsOfArchEnt(\"Legacy\")");

void doNotDelete(){
  showToast("{Delete_Cancelled}");
}

addOnEvent("Site", "show", "removeNavigationButtons()");
addOnEvent("Site", "show", "addNavigationButtons(\"Site\")");
addOnEvent("Trench", "show", "removeNavigationButtons()");
addOnEvent("Trench", "show", "addNavigationButtons(\"Trench\")");
addOnEvent("Trench_Files", "show", "removeNavigationButtons()");
addOnEvent("Trench_Files", "show", "addNavigationButtons(\"Trench_Files\")");
addOnEvent("Locus", "show", "removeNavigationButtons()");
addOnEvent("Locus", "show", "addNavigationButtons(\"Locus\")");
addOnEvent("Stratum_Feature", "show", "removeNavigationButtons()");
addOnEvent("Stratum_Feature", "show", "addNavigationButtons(\"Stratum_Feature\")");
addOnEvent("Sediment_Aggregate", "show", "removeNavigationButtons()");
addOnEvent("Sediment_Aggregate", "show", "addNavigationButtons(\"Sediment_Aggregate\")");
addOnEvent("Photograph_Log", "show", "removeNavigationButtons()");
addOnEvent("Photograph_Log", "show", "addNavigationButtons(\"Photograph_Log\")");
addOnEvent("Diary", "show", "removeNavigationButtons()");
addOnEvent("Diary", "show", "addNavigationButtons(\"Diary\")");
addOnEvent("FCN", "show", "removeNavigationButtons()");
addOnEvent("FCN", "show", "addNavigationButtons(\"FCN\")");
addOnEvent("Soil_Munsel_Color", "show", "removeNavigationButtons()");
addOnEvent("Soil_Munsel_Color", "show", "addNavigationButtons(\"Soil_Munsel_Color\")");
addOnEvent("Legacy", "show", "removeNavigationButtons()");
addOnEvent("Legacy", "show", "addNavigationButtons(\"Legacy\")");

/******************************************************************************/
/*                                   SEARCH                                   */
/******************************************************************************/
addOnEvent("Control/Search"               , "show"  , "search()");
addOnEvent("Control/Search/Entity_List"   , "click" , "loadEntity();");
addOnEvent("Control/Search/Search_Button" , "click" , "search()");
addOnEvent("Control/Search/Search_Term"   , "click" , "clearSearch()");

addOnEvent("Control/Search/Entity_Types"  , "click" , "search()");
entityTypes = new ArrayList();
entityTypes.add(new NameValuePair("{All}", ""));
entityTypes.add(new NameValuePair("{Site}", "Site"));
entityTypes.add(new NameValuePair("{Trench}", "Trench"));
entityTypes.add(new NameValuePair("{Trench_Files}", "Trench Files"));
entityTypes.add(new NameValuePair("{Locus}", "Locus"));
entityTypes.add(new NameValuePair("{Stratum_Feature}", "Stratum Feature"));
entityTypes.add(new NameValuePair("{Sediment_Aggregate}", "Sediment Aggregate"));
entityTypes.add(new NameValuePair("{Photograph_Log}", "Photograph Log"));
entityTypes.add(new NameValuePair("{Diary}", "Diary"));
entityTypes.add(new NameValuePair("{FCN}", "FCN"));
entityTypes.add(new NameValuePair("{Soil_Munsel_Color}", "Soil Munsel Color"));
entityTypes.add(new NameValuePair("{Legacy}", "Legacy"));
populateDropDown("Control/Search/Entity_Types", entityTypes);

void clearSearch(){
  setFieldValue("Control/Search/Search_Term","");
}

void search(){
  String refEntityList  = "Control/Search/Entity_List";
  String refSearchTerm  = "Control/Search/Search_Term";
  String refEntityTypes = "Control/Search/Entity_Types";

  String type = getFieldValue(refEntityTypes);
  String term = getFieldValue(refSearchTerm);
  String searchQuery = "SELECT uuid, response "+
                       "  FROM latestNonDeletedArchEntFormattedIdentifiers  "+
                       " WHERE uuid in (SELECT uuid "+
                       "                  FROM latestNonDeletedArchEntIdentifiers "+
                       "                 WHERE measure LIKE '"+term+"'||'%'  "+
                       "                   AND ( aenttypename LIKE '"+type+"' OR '' = '"+type+"' ) "+
                       "                )  "+
                       " ORDER BY response "+
                       " LIMIT ? "+
                       "OFFSET ? ";

  populateCursorList(refEntityList, searchQuery, 25);
  refreshTabgroupCSS("Control");

  Log.d("Module", "Search query: " + searchQuery);
}

void loadSiteFrom(String uuid) {
  String tabgroup = "Site";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchSite__();
    }
  };

  onPrefetchSite__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadTrenchFrom(String uuid) {
  String tabgroup = "Trench";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchTrench__();
    }
  };

  onPrefetchTrench__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadTrenchFilesFrom(String uuid) {
  String tabgroup = "Trench_Files";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchTrenchFiles__();
    }
  };

  onPrefetchTrenchFiles__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadLocusFrom(String uuid) {
  String tabgroup = "Locus";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchLocus__();
    }
  };

  onPrefetchLocus__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadStratumFeatureFrom(String uuid) {
  String tabgroup = "Stratum_Feature";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchStratumFeature__();
    }
  };

  onPrefetchStratumFeature__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadSedimentAggregateFrom(String uuid) {
  String tabgroup = "Sediment_Aggregate";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchSedimentAggregate__();
    }
  };

  onPrefetchSedimentAggregate__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadPhotographLogFrom(String uuid) {
  String tabgroup = "Photograph_Log";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchPhotographLog__();
    }
  };

  onPrefetchPhotographLog__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadDiaryFrom(String uuid) {
  String tabgroup = "Diary";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchDiary__();
    }
  };

  onPrefetchDiary__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadFCNFrom(String uuid) {
  String tabgroup = "FCN";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchFCN__();
    }
  };

  onPrefetchFCN__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadSoilMunselColorFrom(String uuid) {
  String tabgroup = "Soil_Munsel_Color";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchSoilMunselColor__();
    }
  };

  onPrefetchSoilMunselColor__();
  showTabGroup(tabgroup, uuid, cb);
}
void loadLegacyFrom(String uuid) {
  String tabgroup = "Legacy";
  setUuid(tabgroup, uuid);
  if (isNull(uuid)) return;

  FetchCallback cb = new FetchCallback() {
    onFetch(result) {
      populateEntityListsInTabGroup(tabgroup);
      onFetchLegacy__();
    }
  };

  onPrefetchLegacy__();
  showTabGroup(tabgroup, uuid, cb);
}

/******************************************************************************/
/*                          TAKE FROM GPS BUTTON(S)                           */
/******************************************************************************/
addOnEvent("Trench/Trench/Take_From_GPS_1", "click", "takePoint(\"Trench\")");
addOnEvent("FCN/General/Take_From_GPS_1", "click", "takePoint(\"FCN\")");

Map getTakeFromGpsMappings() {
  Map tabgroupToTabRef = new HashMap();
  tabgroupToTabRef.put("Trench", "Trench/Trench");
tabgroupToTabRef.put("FCN", "FCN/General");
  return tabgroupToTabRef;
}

/* Takes the current point using gps. */
void takePoint(String tabgroup) {
  Map tabgroupToTabRef = getTakeFromGpsMappings();

  String archEntType = tabgroup.replaceAll("_", " ");
  String currentUuid = getUuid(tabgroup);
  if (isNull(currentUuid)){
    showToast("{Please_enter_data_first}");
    return;
  }

  boolean isInternalGPSOff = !isInternalGPSOn();
  boolean isExternalGPSOff = !isExternalGPSOn();
  Object  position = getGPSPosition();
  if (position == null || isInternalGPSOff && isExternalGPSOff) {
    showToast("{GPS_Not_Initialised}");
    return;
  }

  Object projPosition = getGPSPositionProjected();
  Double latitude     = position.getLatitude();
  Double longitude    = position.getLongitude();
  Double northing     = projPosition.getLatitude();
  Double easting      = projPosition.getLongitude();

  samplePoint = new Point(new MapPos(easting, northing), null, (PointStyle) null, null);
  ArrayList geolist = new ArrayList();
  geolist.add(samplePoint);

  String accuracy = "" + getGPSEstimatedAccuracy();
  setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Accuracy", accuracy);

  saveArchEnt(currentUuid, archEntType, geolist, null, new SaveCallback() {
    onSave(uuid, newRecord) {
      print("[takePoint()] Added geometry: " + geolist);
      fillInGPS(tabgroup);
    }
  });
}

/* Sets the value of GPS views for the given tab path. */
void fillInGPS(String tabgroup) {
  Map tabgroupToTabRef = getTakeFromGpsMappings();
  String currentUuid = getUuid(tabgroup);
  if (isNull(currentUuid)) {
    return;
  }

  String query = "SELECT x(transform(geospatialcolumn,                4326)) as longtiude, " +
                 "       y(transform(geospatialcolumn,                4326)) as latitude, " +
                 "       x(transform(geospatialcolumn, "+getModuleSrid()+")) as easting, " +
                 "       y(transform(geospatialcolumn, "+getModuleSrid()+")) as northing " +
                 "  FROM latestnondeletedarchent, vocabulary " +
                 " WHERE uuid = '" + currentUuid + "';";

  fetchOne(query, new FetchCallback() {
    onFetch(result) {
      print("[fillInGPS()] Fetched DB transformed geometry: " + result);
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Longitude" , result.get(0));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Latitude"  , result.get(1));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Easting"   , result.get(2));
      setFieldValue(tabgroupToTabRef.get(tabgroup) + "/Northing"  , result.get(3));
    }
  });
}

void clearGpsInTabGroup(String tabgroup) {
  Map tabgroupToTabRef = getTakeFromGpsMappings();

  String tabRef = tabgroupToTabRef.get(tabgroup);
  if (isNull(tabRef)) return;

  clearGpsInTab(tabRef);
}

void clearGpsInTab(String tabRef) {
  setFieldValue(tabRef + "/Accuracy"  , "");
  setFieldValue(tabRef + "/Latitude"  , "");
  setFieldValue(tabRef + "/Longitude" , "");
  setFieldValue(tabRef + "/Easting"   , "");
  setFieldValue(tabRef + "/Northing"  , "");
}

/*************** LOADING AND CREATION OF RECORDS FROM QR CODES ****************/
void bindQrScanning(String refButton, String refField) {
  String event = "click";

  String stmt = fun2str("scanRecordFromQrCode", refField);

  addOnEvent(refButton, event, stmt);
}

void scanRecordFromQrCode(String ref) {
  String callback = fun2str("loadOrCreateEntityFromScannedAttrib", ref);
  scanCode(callback);
}

void loadOrCreateEntityFromScannedAttrib(String ref) {
  String attrName = getAttributeName(ref);
  String attribVal  = getLastScanContents();

  String q = "";
  q += "SELECT uuid ";
  q += "  FROM latestnondeletedaentvalue ";
  q += "  JOIN latestnondeletedarchent USING (uuid) ";
  q += "  JOIN attributekey            USING (attributeid) ";
  q += " WHERE attributename = '{attrName}' ";
  q += "   AND measure       = '{attribVal}' ";
  q  = replaceFirst(q, "{attrName}",  attrName);
  q  = replaceFirst(q, "{attribVal}", attribVal );

  FetchCallback loadOrCreateEntity = new FetchCallback() {
    onFetch(result) {
      if (isNull(result) || result.size() == 0) {
        createRecordFromScannedAttrib(ref);
      } else {
        String uuid = result.get(0).get(0);
        loadEntityFrom(uuid);
      }
    }
  };

  fetchAll(q, loadOrCreateEntity);
}

void initScannedAttrib(String ref) {
  String oldCode = getFieldValue(ref);
  String newCode = getLastScanContents();

  if (isNull(oldCode))
    setFieldValue(ref, newCode);
}

void createRecordFromScannedAttrib(String ref) {
  String tabGroup = getTabGroupRef(ref);
  newRecord(tabGroup);

  initScannedAttrib(ref);
}



/******************************************************************************/
/*                       AUTONUMBERING HELPER FUNCTIONS                       */
/******************************************************************************/
/*
 * If value of field specified by `ref` is null, sets the field to `defaultVal`,
 * otherwise increments its value.
 *
 * Returns the value the field was updated to.
 */
Integer incField(String ref, Integer defaultVal) {
  String val = getFieldValue(ref);

  if (isNull(val)) {
    setFieldValue(ref, defaultVal);
    return defaultVal;
  }

  Integer inc = Integer.parseInt(val) + 1;
  setFieldValue(ref, inc);
  insertIntoLocalSettings(ref, inc.toString());

  return inc;
}

/* Increments the field at `ref` or returns null if it does not contain a
 * number.
 */
Integer incField(String ref) {
  return incField(ref, 1);
}

List getStartingIdPaths() {
  List l = new ArrayList();
  l.add("Control/Next_IDs/Next_Locus_Locus_ID");
  l.add("Control/Next_IDs/Next_Stratum_Feature_ID");
  l.add("Control/Next_IDs/Next_FCN_ID");
  return l;
}

void loadStartingId(String ref) {
  // If there's already a value in the field, we don't need to load one.
  String val = getFieldValue(ref);
  if (!isNull(val)) {
    return;
  }

  // Load a value into the field. Set it to 1 if no value has been previously
  // saved.
  String idQ = "SELECT value FROM localSettings WHERE key = '" + ref + "';";
  fetchOne(idQ, new FetchCallback() {
    onFetch(result) {
      if (isNull(result)) setFieldValue(ref, "1"          );
      else                setFieldValue(ref, result.get(0));
    }
  });
}

loadStartingIds() {
  List l = getStartingIdPaths();

  for (ref : l) {
    loadStartingId(ref);
  }
}

addOnEvent("Control", "show", "loadStartingIds()");

/*
 * Sets bindings to save autonum'd fields whenever they're blurred.
 */
for (ref : getStartingIdPaths()) {
  onFocus(ref, null, "insertIntoLocalSettings(\"" + ref + "\", getFieldValue(\"" + ref + "\"));");
}

void incAutoNum(String destPath) {
  Map destToSource = new HashMap();
  destToSource.put("Locus/General/Locus_Locus_ID", "Control/Next_IDs/Next_Locus_Locus_ID");
  destToSource.put("Stratum_Feature/General/Stratum_Feature_ID", "Control/Next_IDs/Next_Stratum_Feature_ID");
  destToSource.put("FCN/General/FCN_ID", "Control/Next_IDs/Next_FCN_ID");

  String sourcePath = destToSource.get(destPath);
  String destVal    = getFieldValue(sourcePath);
  setFieldValue(destPath, destVal);
  incField(sourcePath);
}

/******************************************************************************/
/*                POPULATION OF ENTITY AND CHILD ENTITY LISTS                 */
/******************************************************************************/
/*
 * `viewType`   the type of GUI element to be populated. It can either equal
 *              "DropDown" or "List".
 * `path`       the reference of the GUI element to be populated.
 * `parentUuid` the parent in the relationship denoted by `relType`.
 * `entType`    the type of the entities the menu will be populated with.
 * `relType`    the name of the relationship the children are to be in with the
 *              entity denoted by `parentUuid`.
 */
void populateMenuWithEntities (
  String viewType,
  String path,
  String parentUuid,
  String entType,
  String relType
) {
  String getChildEntitiesQ = "" +
    "SELECT childuuid, response "+
    "  FROM parentchild JOIN latestNonDeletedArchEntFormattedIdentifiers ON (childuuid = uuid) " +
    "  JOIN createdmodifiedatby USING (uuid) " +
    " WHERE relationshipid IN (SELECT relationshipid  " +
    "                            FROM latestnondeletedrelationship JOIN relntype USING (relntypeid) " +
    "                           WHERE relntypename = '"+relType+"') " +
    "   AND parentuuid = '" + parentUuid + "' " +
    "   AND (childaenttypename = '"+entType+"' OR '"+entType+"' = '') " +
    " ORDER BY createdat DESC ";

  String getEntitiesQ = "" +
    "SELECT uuid, response "+
    "  FROM latestNonDeletedArchEntFormattedIdentifiers  "+
    " WHERE uuid in (SELECT uuid "+
    "                  FROM latestNonDeletedArchEntIdentifiers "+
    "                 WHERE aenttypename = '"+entType+"' OR '"+entType+"' = '' " +
    "               )  "+
    " ORDER BY response ";

  String q = null;
  if (relType.equals("")) {
    q = getEntitiesQ;
  } else {
    q = getChildEntitiesQ;
  }

  FetchCallback cbPopulateDropDown = new FetchCallback() {
    onFetch(result) {
      populateDropDown(path, result, true);
    }
  };

  switch (viewType) {
    case "DropDown":
      fetchAll(q, cbPopulateDropDown);
      break;
    case "List":
      q += " LIMIT ? OFFSET ? ";
      populateCursorList(path, q, 25);
      break;
    default:
      Log.e("populateMenuWithEntities ", "Unexpected type '" + viewType + "'");
  }
}

void populateEntityListsInTabGroup(String tabGroup) {
  if (isNull(tabGroup)) {
    return;
  }

  for (m : ENTITY_MENUS) {
    String path         = m[1];
    String menuTabGroup = getTabGroupRef(path);
    String functionCall = getEntityMenuPopulationFunction(m);

    if (menuTabGroup.equals(tabGroup))
      execute(functionCall);
  }
}

/* Populates each list containing records whose archent type is the same as that
 * of `tabGroup`.
 */
void populateEntityListsOfArchEnt(String tabGroup) {
  if (isNull(tabGroup)) {
    return;
  }

  String archEntTypeToPopulate = getArchEntType(tabGroup);

  for (m : ENTITY_MENUS) {
    String archEntType  = m[3];
    String functionCall = getEntityMenuPopulationFunction(m);

    if (archEntType.equals(archEntTypeToPopulate))
      execute(functionCall);
  }
}

String getEntityMenuPopulationFunction(String[] menuDescriptor) {
  String viewType       = menuDescriptor[0];
  String path           = menuDescriptor[1];
  String parentUuidCall = menuDescriptor[2];
  String entType        = menuDescriptor[3];
  String relType        = menuDescriptor[4];

  String functionCall = "";
  functionCall += "populateMenuWithEntities(";
  functionCall += "\"" + viewType       + "\"";
  functionCall += ", ";
  functionCall += "\"" + path           + "\"";
  functionCall += ", ";
  functionCall +=        parentUuidCall       ;
  functionCall += ", ";
  functionCall += "\"" + entType        + "\"";
  functionCall += ", ";
  functionCall += "\"" + relType        + "\"";
  functionCall += ")";

  return functionCall;
}

ENTITY_MENUS = new ArrayList();
ENTITY_MENUS.add(new String[] {
    "List",
    "Control/Site/Choose_an_Existing_Site",
    "getUuid(\"Control\")",
    "Site",
    ""
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Site/Site/List_of_Existing_Trenches",
    "getUuid(\"Site\")",
    "Trench",
    "Site - Trench"
});
ENTITY_MENUS.add(new String[] {
    "DropDown",
    "Trench/Trench/Attached_Trench_Files",
    "getUuid(\"Trench\")",
    "Trench Files",
    "Trench - Trench Files"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Trench/Loci/List_of_Existing_Loci",
    "getUuid(\"Trench\")",
    "Locus",
    "Trench - Locus"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Trench/Strata_Features/List_of_Existing_Strata_Features",
    "getUuid(\"Trench\")",
    "Stratum Feature",
    "Trench - Stratum Feature"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Trench/Diaries/List_of_Existing_Diaries",
    "getUuid(\"Trench\")",
    "Diary",
    "Trench - Diary"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Trench/Legacies/List_of_Existing_Legacies",
    "getUuid(\"Trench\")",
    "Legacy",
    "Trench - Legacy"
});
ENTITY_MENUS.add(new String[] {
    "DropDown",
    "Locus/Deposit/Munsel_Colors",
    "getUuid(\"Locus\")",
    "Soil Munsel Color",
    "Locus - Soil Munsel Color"
});
ENTITY_MENUS.add(new String[] {
    "DropDown",
    "Locus/Deposit/Associated_Sediment_Aggregates",
    "getUuid(\"Locus\")",
    "Sediment Aggregate",
    "Locus - Sediment Aggregate"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Locus/FCNs/List_of_Related_FCNs",
    "getUuid(\"Locus\")",
    "FCN",
    "Locus - FCN"
});
ENTITY_MENUS.add(new String[] {
    "DropDown",
    "Locus/Add/Select_a_Photograph_Log",
    "getUuid(\"Locus\")",
    "Photograph Log",
    "Locus - Photograph Log"
});
ENTITY_MENUS.add(new String[] {
    "DropDown",
    "Stratum_Feature/Add/Select_a_Photograph_Log",
    "getUuid(\"Stratum_Feature\")",
    "Photograph Log",
    "Stratum Feature - Photograph Log"
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Relationship/Legacies/List_of_Existing_Legacies",
    "getUuid(\"Relationship\")",
    "Legacy",
    ""
});
ENTITY_MENUS.add(new String[] {
    "List",
    "Stratum_Feature_Relationship/Legacies/List_of_Existing_Legacies",
    "getUuid(\"Stratum_Feature_Relationship\")",
    "Legacy",
    ""
});
for (m : ENTITY_MENUS) {
  String functionCall = getEntityMenuPopulationFunction(m);
  execute(functionCall);
}
for (m : ENTITY_MENUS) {
  String menuRef = m[1];

  String ref = getTabRef(menuRef);
  String evt = "show";
  String cmd = "clearField(\"{menuRef}\")";
  cmd = replaceFirst(cmd, "{menuRef}", menuRef);

  addOnEvent(ref, evt, cmd);
}

addOnEvent("Control/Site/Choose_an_Existing_Site", "click", "loadEntity()");
addOnEvent("Site/Site/List_of_Existing_Trenches", "click", "loadEntity()");
addOnEvent("Trench/Trench/Attached_Trench_Files", "click", "loadEntity(true)");
addOnEvent("Trench/Loci/List_of_Existing_Loci", "click", "loadEntity()");
addOnEvent("Trench/Strata_Features/List_of_Existing_Strata_Features", "click", "loadEntity()");
addOnEvent("Trench/Diaries/List_of_Existing_Diaries", "click", "loadEntity()");
addOnEvent("Trench/Legacies/List_of_Existing_Legacies", "click", "loadEntity()");
addOnEvent("Locus/Deposit/Munsel_Colors", "click", "loadEntity(true)");
addOnEvent("Locus/Deposit/Associated_Sediment_Aggregates", "click", "loadEntity(true)");
addOnEvent("Locus/FCNs/List_of_Related_FCNs", "click", "loadEntity()");
addOnEvent("Locus/Add/Select_a_Photograph_Log", "click", "loadEntity(true)");
addOnEvent("Stratum_Feature/Add/Select_a_Photograph_Log", "click", "loadEntity(true)");
addOnEvent("Relationship/Legacies/List_of_Existing_Legacies", "click", "loadEntity()");
addOnEvent("Stratum_Feature_Relationship/Legacies/List_of_Existing_Legacies", "click", "loadEntity()");
/******************************************************************************/
/*                             HANDWRITTEN LOGIC                              */
/******************************************************************************/

/********************************* TOP MATTER *********************************/

setFileSyncEnabled(false);
setSyncEnabled    (false);

/*********************************** SHARED ***********************************/
String WEB_REL_NONE = "<i>None</i>";

locusIdentifer = "";

void populateSquare(String ref) {
  String q = "";
  q += " SELECT DISTINCT measure, measure";
  q += " FROM            latestnondeletedaentvalue";
  q += " JOIN            attributekey USING (attributeid)";
  q += " WHERE           attributename = 'Square'";
  q += " AND             measure IS NOT NULL";
  q += " ORDER BY        measure;";

  FetchCallback populate = new FetchCallback() {
    onFetch(result) {
      populateDropDown(ref, result);
    }
  };

  fetchAll(q, populate);
}

void setFieldToIdentifier(String identiferType, String lotRef) {
  String uuid = getUuid(identiferType);

  if (isNull(uuid)) {
    populateWebViewHtml(lotRef, "&nbsp;");
    return;
  }

  String q = "";
  q += "SELECT uuid, response ";
  q += "FROM latestnondeletedarchentformattedidentifiers ";
  q += "WHERE uuid = '%s' ";
  q  = replaceFirst(q, "%s", uuid);

  cb = new FetchCallback() {
    onFetch(result) {
      locusIdentifer  = result.get(1);

      populateWebViewHtml(lotRef, locusIdentifer);
    }
  };

  fetchOne(q, cb);
}

void populateLotLabel(String lotRef) {
  identiferType = "Locus";
  setFieldToIdentifier(identiferType, lotRef);
}
/******************************* RELATIONSHIPS ********************************/
/* Variables and functions shared by entity-specfic code fo relating          */
/* entities.                                                                  */
/******************************************************************************/
addOnEvent("Locus",                    "show", "onDisplayParent()");
addOnEvent("Relationship",               "show", "onDisplayRelationship()");
addOnEvent("Stratum_Feature",              "show", "CGonDisplayParent()");
addOnEvent("Stratum_Feature_Relationship", "show", "CGonDisplayRelationship()");

String WEB_REL_DESC_FMT      = "%s <u>&nbsp;%s&nbsp;</u> <u>&nbsp;%s&nbsp;</u>";
String WEB_REL_DESC_FILL     = "?";
String WEB_REL_BLANK         = "&nbsp;";

String selectedRelId         = null;
String selectedRelIdentifier = null;
String selectedChildUuid     = null;

String proposedChildUuid       = null;
String proposedChildIdentifier = null;

String displayedTabGroup     = null;

void onDisplayParent()            {displayedTabGroup = "Locus";}
void onDisplayRelationship()      {displayedTabGroup = "Relationship";}
boolean isDisplayedParent()       {return displayedTabGroup.equals("Locus");}
boolean isDisplayedRelationship() {return displayedTabGroup.equals("Relationship");}

void CGonDisplayParent()            {displayedTabGroup = "Stratum_Feature";}
void CGonDisplayRelationship()      {displayedTabGroup = "Stratum_Feature_Relationship";}
boolean CGisDisplayedParent()       {return displayedTabGroup.equals("Stratum_Feature");}
boolean CGisDisplayedRelationship() {return displayedTabGroup.equals("Stratum_Feature_Relationship");}

// Depends on the following globals:
//   - selectedRelId
//   - userid        (Defined by autogen)
void deleteRelationship() {
  if (isNull(selectedRelId)) {
    showToast("{no_relationship_selected}");
    return;
  }

  String q = "";
  q += " INSERT INTO aentreln (uuid, relationshipid, deleted, participatesverb, userid)";
  q += " SELECT uuid, relationshipid, 'true', participatesverb, '"+userid+"'";
  q += " FROM latestnondeletedaentreln";
  q += " WHERE relationshipid = '"+selectedRelId+"'";

  DeleteCallback cb = new DeleteCallback() {
    onDelete(uuid) {
      deleteRelationshipSuceeded();
    }
  };

  fetchOne(q);
  deleteRel(selectedRelId, cb);

  selectedRelId         = null;
  selectedRelIdentifier = null;
}

void deleteRelationshipSuceeded() {
  String refSelectedRelRel    = "Relationship/Relationships/Selected_Relationship";
  String refSelectedRelParent = "Locus/Relationships/Selected_Relationship";
  if (isDisplayedParent()) {
    populateWebViewHtml(refSelectedRelParent, WEB_REL_NONE);
    populateExistingRelationships();
  }
  if (isDisplayedRelationship()) {
    populateWebViewHtml(refSelectedRelRel,    WEB_REL_NONE);
    searchRelationship();
  }

  String CGrefSelectedRelRel    = "Stratum_Feature_Relationship/Relationships/Selected_Relationship";
  String CGrefSelectedRelParent = "Stratum_Feature/Stratum_Feature_Loci/Selected_Relationship";
  if (CGisDisplayedParent()) {
    populateWebViewHtml(CGrefSelectedRelParent, WEB_REL_NONE);
    CGpopulateExistingRelationships();
  }
  if (CGisDisplayedRelationship()) {
    populateWebViewHtml(CGrefSelectedRelRel,    WEB_REL_NONE);
    CGsearchRelationship();
  }
}

String getSelectedRelationshipComponent(String ref, String component) {
  String   val       = getFieldValue(ref);
  String[] arguments = null;
  if (val == null)
      return null;
  else
      arguments = val.split("~!~");

  String   relationshipName = arguments[0];
  String   parentRole       = arguments[1];
  String   childRole        = arguments[2];

  component = component.toLowerCase();
  if      (component.equals("name"))   return relationshipName;
  else if (component.equals("parent")) return parentRole;
  else if (component.equals("child"))  return childRole;
  else                                 return null;
}

void loadRelatedEntity() {
  if (isNull(selectedChildUuid)) {
    showToast("{no_relationship_selected}");
    return;
  }
  loadEntityFrom(selectedChildUuid);
}

/**************************** USER TAB VALIDATION *****************************/
/* The autogen defines its own `onClickUserLogin` function. This is           */
/* overridden using @POSTPROC.                                                */
/******************************************************************************/

// Overrides autogenerated function
void onClickUserUserListLogin () {
  String refUsers      = userMenuPath; // Defined by autogen
  String refDeviceCode = "User/User_List/Device_Code";

  String vocabIdUsers      = getFieldValue(refUsers);
  String vocabIdDeviceCode = getFieldValue(refDeviceCode);

  Boolean isSelectedUsers      = !isNull(vocabIdUsers);
  Boolean isSelectedDeviceCode = !isNull(vocabIdDeviceCode);

  if (!isSelectedUsers)      { noUsersSelected();      return; }
  if (!isSelectedDeviceCode) { noDeviceCodeSelected(); return; }

  newTab("Control", true);
}

void noUsersSelected() {
  String msgHead = "{no_user_selected_head}";
  String msgBody = "{no_user_selected_body}";
  showWarning(msgHead, msgBody);
}

void noDeviceCodeSelected() {
  msgHead = "{no_device_code_selected_head}";
  msgBody = "{no_device_code_selected_body}";
  showWarning(msgHead, msgBody);
}
/******************************* RELATIONSHIPS ********************************/
/* Locus-to-Locus relationships.                                              */
/*                                                                            */
/* Uses functions from logic/relationships-shared.bsh                         */
/*                                                                            */
/* Modifies onClickLocusCreateRelationshipstoThisLocus using @POSTPROC.       */
/******************************************************************************/
//////////////////// FUNCTIONS AFFECTING CONTEXT TAB GROUP /////////////////////
addOnEvent("Locus",                                    "show",  "initParentRelationshipGlobals()");
addOnEvent("Locus",                                    "show",  "populateExistingRelationships()");
addOnEvent("Locus/Relationships/Load_Related_Locus", "click", "loadRelatedEntity()");

addOnEvent("Locus/Relationships/Existing_Relationships_to_This_Locus", "click", "selectRelationship()");
addOnEvent("Locus/Relationships/Delete_Relationship",                    "click", "deleteRelationship()");

void initParentRelationshipGlobals() {
  String refSelectedRelParent = "Locus/Relationships/Selected_Relationship";

  selectedChildUuid     = null;
  selectedRelId         = null;
  selectedRelIdentifier = null;

  populateWebViewHtml(refSelectedRelParent, WEB_REL_NONE);
}

void populateExistingRelationships(){
  String tabGroup    = "Locus";
  String currentUuid = getUuid(tabGroup);
  String refExistingRelationships = "Locus/Relationships/Existing_Relationships_to_This_Locus";

  String q = getRelatedChildQuery(currentUuid);

  populateCursorList(refExistingRelationships, q, 25);
  refreshTabgroupCSS(tabGroup);
}

void selectRelationship() {
  String refSelectedRelParent = "Locus/Relationships/Selected_Relationship";

  String val = getListItemValue();
  if (isNull(val)) return;

  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("related")) return;

  selectedRelId         = arguments[1];
  selectedRelIdentifier = arguments[2];
  selectedChildUuid     = arguments[3];

  populateWebViewHtml(refSelectedRelParent, selectedRelIdentifier);
}

////////////////// FUNCTIONS AFFECTING RELATIONSHIP TAB GROUP //////////////////
addOnEvent("Relationship",                                      "show",  "initRelationshipRelationshipGlobals()");
addOnEvent("Relationship/Relationships/Add_Relationship",       "click", "addRelationship()");
addOnEvent("Relationship/Relationships/Delete_Relationship",    "click", "deleteRelationship()");
addOnEvent("Relationship/Relationships/Existing_Relationships", "click", "selectExistingRelationship()");
addOnEvent("Relationship/Relationships/Relationship_Type",      "click", "populateProposedRelationship()");
addOnEvent("Relationship/Relationships/Search",                 "click", "populateProposedRelationship()");
addOnEvent("Relationship/Relationships/Search",                 "click", "searchRelationship()");
addOnEvent("Relationship/Relationships/Unrelated_Loci",     "click", "selectUnrelatedEntity()");

void initRelationshipRelationshipGlobals() {
  String refSelectedRelRel = "Relationship/Relationships/Selected_Relationship";

  proposedChildUuid       = null;
  selectedRelId           = null;
  proposedChildIdentifier = null;
  selectedRelIdentifier   = WEB_REL_BLANK;

  populateWebViewHtml(refSelectedRelRel, selectedRelIdentifier);

  populateParentIdentiferRelationships();
  populateProposedRelationship();
  clearSearch();
}

void populateRelationshipType() {
  refRelationshipType = "Relationship/Relationships/Relationship_Type";

  String q = "";
  q += "SELECT relntypename||'~!~'||coalesce(nullif(parent||'~!~'||child,'~!~'),relntypename||'~!~'||relntypename) as relntypeid, coalesce(nullif(parent,''), relntypename) as name, relntypeid ";
  q += "  FROM relntype ";
  q += " WHERE relntypename not like '%-%' ";
  q += " UNION ";
  q += " SELECT relntypename||'~!~'||coalesce(nullif(child||'~!~'||parent,'~!~'),relntypename||'~!~'||relntypename), coalesce(nullif(child,''), relntypename) as name, relntypeid ";
  q += "  FROM relntype ";
  q += " WHERE relntypename not like '%-%' ";
  q += " ORDER BY relntypeid, name";

  FetchCallback populate = new FetchCallback() {
    onFetch(result) {
      populateDropDown(refRelationshipType, result);
    }
  };

  fetchAll(q, populate);
}

void populateProposedRelationship() {
  String refProposedRel = "Relationship/Relationships/Proposed_Relationship";
  String refRelType     = "Relationship/Relationships/Relationship_Type";

  String identifierFrom;
  String relationship;
  String identifierTo;

  identifierFrom = locusIdentifer; // Defined in logic/shared.bsh
  relationship   = getSelectedRelationshipComponent(refRelType, "parent");
  identifierTo   = proposedChildIdentifier;

  if (isNull(identifierFrom)) identifierFrom = WEB_REL_DESC_FILL;
  if (isNull(relationship  )) relationship   = WEB_REL_DESC_FILL;
  if (isNull(identifierTo  )) identifierTo   = WEB_REL_DESC_FILL;

  String webviewHtml = WEB_REL_DESC_FMT;
  webviewHtml = replaceFirst(webviewHtml, "%s", identifierFrom);
  webviewHtml = replaceFirst(webviewHtml, "%s", relationship  );
  webviewHtml = replaceFirst(webviewHtml, "%s", identifierTo  );

  populateWebViewHtml(refProposedRel, webviewHtml);
}

void searchRelationship() {
  String parentTabGroup = "Locus";
  String parentUuid     = getUuid(parentTabGroup);

  String tabGroup     = "Relationship";
  String refUnrelated = "Relationship/Relationships/Unrelated_Loci";
  String refRelated   = "Relationship/Relationships/Existing_Relationships";
  String refRelType   = "Relationship/Relationships/Relationship_Type";
  String refTrenchId  = "Relationship/Relationships/Trench_ID";
  String refLocusId   = "Relationship/Relationships/Locus_ID";
  String refSiteName  = "Relationship/Vars/Relationship_Site_Name";
  String refSiteYear  = "Relationship/Vars/Relationship_Year_of_Campaign";

  String trenchId   = getFieldValue(refTrenchId);
  String locusId    = getFieldValue(refLocusId);
  String siteName   = getFieldValue(refSiteName);
  String siteYear   = getFieldValue(refSiteYear);
  String parentRole = getSelectedRelationshipComponent(refRelType, "parent");
  String unrelatedQ = "";
  String relatedQ   = "";

  if (isNull(trenchId)) {
    msgHead  = "{trench_id_required_head}";
    msgBody  = "{trench_id_required_body}";
    showWarning(msgHead, msgBody);
    return;
  }

  unrelatedQ += " SELECT 'unrelated' || char(0) || uuid || char(0) || response, response";
  unrelatedQ += "   FROM latestNonDeletedArchEntFormattedIdentifiers";
  unrelatedQ += "  WHERE uuid IN (";
  unrelatedQ += "         SELECT uuid";
  unrelatedQ += "           FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid)";
  unrelatedQ += "          WHERE attributename LIKE '% Trench ID'";
  unrelatedQ += "            AND measure = '{Locus_Trench_ID}'";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Locus ID'";
  unrelatedQ += "                    AND (measure = '{Locus_Locus_ID}' OR '{Locus_Locus_ID}' = ''))";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Site Name'";
  unrelatedQ += "                    AND measure = '{Relationship_Site_Name}')";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Year of Campaign'";
  unrelatedQ += "                    AND measure = '{Relationship_Year_of_Campaign}')";
  unrelatedQ += "            AND uuid NOT IN (";
  unrelatedQ += "                 SELECT childuuid";
  unrelatedQ += "                   FROM parentchild";
  unrelatedQ += "                  WHERE parentuuid = '{parentUuid}'";
  unrelatedQ += "                    AND parentparticipatesverb = '{parentRole}')";
  unrelatedQ += "            AND uuid != '{parentUuid}')";
  unrelatedQ += "    AND aenttypename IN ('Locus', 'Legacy')";
  unrelatedQ += " ORDER BY response";
  unrelatedQ += " LIMIT ? OFFSET ?";
  unrelatedQ  = replaceFirst(unrelatedQ, "{Locus_Trench_ID}",               trenchId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Locus_Locus_ID}",                locusId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Locus_Locus_ID}",                locusId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Relationship_Site_Name}",        siteName);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Relationship_Year_of_Campaign}", siteYear);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentUuid}",                    parentUuid);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentUuid}",                    parentUuid);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentRole}",                    parentRole);

  relatedQ += getRelatedChildQuery(parentUuid);

  populateCursorList(refUnrelated, unrelatedQ, 25);
  populateCursorList(refRelated,   relatedQ,   25);

  proposedChildUuid = null; proposedChildIdentifier = null;
  populateProposedRelationship();
}

void clearSearch() {
  String refUnrelated = "Relationship/Relationships/Unrelated_Loci";
  String refRelated   = "Relationship/Relationships/Existing_Relationships";

  String q = "SELECT '' WHERE 0 LIMIT ? OFFSET ?";
  populateCursorList(refUnrelated, q, 25);
  populateCursorList(refRelated,   q, 25);
}

void selectUnrelatedEntity() {
  String val = getListItemValue();
  if (isNull(val)) return;
  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("unrelated")) return;

  proposedChildUuid       = arguments[1];
  proposedChildIdentifier = arguments[2];

  populateProposedRelationship();
}

void addRelationship() {
  String parentTabGroup = "Locus";
  String refRelType     = "Relationship/Relationships/Relationship_Type";

  String relName    = getSelectedRelationshipComponent(refRelType, "name");
  String parentUuid = getUuid(parentTabGroup);
  String childUuid  = proposedChildUuid;
  String parentRole = getSelectedRelationshipComponent(refRelType, "parent");
  String childRole  = getSelectedRelationshipComponent(refRelType, "child");
  String callback   = "addRelationshipSucceeded()";

  if (isNull(parentUuid)) {
    String msgHead = "{logic_error_head}";
    String msgBody = "{logic_error_body}";
    showWarning(msgHead, msgBody);
    return;
  }
  if (isNull(childUuid)) {
    showToast("no_locus_selected");
    return;
  }

  saveEntitiesToHierRel(
      relName,
      parentUuid, childUuid,
      parentRole, childRole,
      callback
  );

  proposedChildUuid       = null;
  proposedChildIdentifier = null;
}

void addRelationshipSucceeded() {
  String refProposedRel = "Relationship/Relationships/Proposed_Relationship";

  populateWebViewHtml(refProposedRel, WEB_REL_BLANK);

  searchRelationship();
}

void selectExistingRelationship() {
  String refSelectedRelRel = "Relationship/Relationships/Selected_Relationship";

  String val = getListItemValue();
  if (isNull(val)) return;

  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("related")) return;

  selectedRelId         = arguments[1];
  selectedRelIdentifier = arguments[2];

  populateWebViewHtml(refSelectedRelRel, selectedRelIdentifier);
}

void populateParentIdentiferRelationships() {
  String lotRef = "Relationship/Relationships/Parent_Identifier";
  populateLotLabel(lotRef); // Defined in logic/shared.bsh
}

String getRelatedChildQuery(String parentUuid) {
  // `locusIdentifer` is defined in logic/shared.bsh
  String parentIdentifier = locusIdentifer;

  String relatedQ = "";
  relatedQ += "SELECT 'related' || char(0) || relationshipid || char(0) || '"+parentIdentifier+" ' || parentparticipatesverb ||' '|| response || char(0) || childuuid, '"+parentIdentifier+"'||' '||parentparticipatesverb||' '||response";
  relatedQ += "  FROM parentchild JOIN latestNonDeletedArchEntFormattedIdentifiers on (childuuid = uuid) ";
  relatedQ += "  JOIN createdmodifiedatby USING (uuid) ";
  relatedQ += " WHERE relationshipid IN (SELECT relationshipid  ";
  relatedQ += "                            FROM latestnondeletedrelationship JOIN relntype USING (relntypeid)  ";
  relatedQ += "                           WHERE relntypename NOT like '% - %') ";
  relatedQ += "   and parentuuid = '"+parentUuid+"' ";
  relatedQ += " ORDER BY createdat desc ";
  relatedQ += " LIMIT ? OFFSET ? ";
  return relatedQ;
}

// Overrides autogenerated definition
void onClickLocusRelationshipsCreateRelationshipstoThisLocus () {
  String tabgroup = "Locus";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }

  newTab("Relationship", true);
}

populateRelationshipType();
/******************************* RELATIONSHIPS ********************************/
/* Stratum Feature to Locus relationships.                                  */
/*                                                                            */
/* Uses functions and globals from logic/relationships-shared.bsh             */
/*                                                                            */
/* Modifies onClickStratumFeatureCreateRelationshipstoThisStratumFeature      */
/* using  @POSTPROC.                                                          */
/******************************************************************************/
//////////////// FUNCTIONS AFFECTING "CONTEXT GROUP" TAB GROUP /////////////////
addOnEvent("Stratum_Feature",                                    "show",  "CGinitParentRelationshipGlobals()");
addOnEvent("Stratum_Feature",                                    "show",  "CGpopulateExistingRelationships()");
addOnEvent("Stratum_Feature/Stratum_Feature_Loci/Load_Related_Locus", "click", "loadRelatedEntity()");

addOnEvent("Stratum_Feature/Stratum_Feature_Loci/Existing_Relationships_to_This_Stratum_Feature", "click", "CGSelectRelationship()");
addOnEvent("Stratum_Feature/Stratum_Feature_Loci/Delete_Relationship",                    "click", "deleteRelationship()");

void CGinitParentRelationshipGlobals() {
  String refSelectedRelParent = "Stratum_Feature/Stratum_Feature_Loci/Selected_Relationship";

  selectedChildUuid     = null;
  selectedRelId         = null;
  selectedRelIdentifier = null;

  populateWebViewHtml(refSelectedRelParent, WEB_REL_NONE);
}

void CGpopulateExistingRelationships(){
  String tabGroup    = "Stratum_Feature";
  String currentUuid = getUuid(tabGroup);
  String refExistingRelationships = "Stratum_Feature/Stratum_Feature_Loci/Existing_Relationships_to_This_Stratum_Feature";

  String q = getCGChildQuery(currentUuid);

  populateCursorList(refExistingRelationships, q, 25);
  refreshTabgroupCSS(tabGroup);
}

void CGSelectRelationship() {
  String refSelectedRelParent = "Stratum_Feature/Stratum_Feature_Loci/Selected_Relationship";

  String val = getListItemValue();
  if (isNull(val)) return;

  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("related")) return;

  selectedRelId         = arguments[1];
  selectedRelIdentifier = arguments[2];
  selectedChildUuid     = arguments[3];

  populateWebViewHtml(refSelectedRelParent, selectedRelIdentifier);
}

////////////////// FUNCTIONS AFFECTING RELATIONSHIP TAB GROUP //////////////////
addOnEvent("Stratum_Feature_Relationship",                                      "show",  "CGinitRelationshipRelationshipGlobals()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Add_Relationship",       "click", "CGaddRelationship()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Delete_Relationship",    "click", "deleteRelationship()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Existing_Relationships", "click", "CGselectExistingRelationship()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Search",                 "click", "CGpopulateProposedRelationship()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Search",                 "click", "CGsearchRelationship()");
addOnEvent("Stratum_Feature_Relationship/Relationships/Unrelated_Loci",     "click", "CGselectUnrelatedEntity()");

void CGinitRelationshipRelationshipGlobals() {
  String refSelectedRelRel = "Stratum_Feature_Relationship/Relationships/Selected_Relationship";

  proposedChildUuid       = null;
  selectedRelId           = null;
  proposedChildIdentifier = null;
  selectedRelIdentifier   = WEB_REL_BLANK;

  populateWebViewHtml(refSelectedRelRel, selectedRelIdentifier);

  CGpopulateParentIdentiferRelationships();
  CGpopulateProposedRelationship();
  CGclearSearch();
}

void CGpopulateProposedRelationship() {
  String refProposedRel = "Stratum_Feature_Relationship/Relationships/Proposed_Relationship";

  String identifierFrom;
  String relationship;
  String identifierTo;

  identifierFrom = locusIdentifer; // Defined in logic/shared.bsh
  relationship   = "{includes}";
  identifierTo   = proposedChildIdentifier;

  if (isNull(identifierFrom)) identifierFrom = WEB_REL_DESC_FILL;
  if (isNull(relationship  )) relationship   = WEB_REL_DESC_FILL;
  if (isNull(identifierTo  )) identifierTo   = WEB_REL_DESC_FILL;

  String webviewHtml = WEB_REL_DESC_FMT;
  webviewHtml = replaceFirst(webviewHtml, "%s", identifierFrom);
  webviewHtml = replaceFirst(webviewHtml, "%s", relationship  );
  webviewHtml = replaceFirst(webviewHtml, "%s", identifierTo  );

  populateWebViewHtml(refProposedRel, webviewHtml);

  String refSelectedRelParent = "Stratum_Feature/Stratum_Feature_Loci/Selected_Relationship";
  populateWebViewHtml(refSelectedRelParent, WEB_REL_BLANK);
}

void CGsearchRelationship() {
  String parentTabGroup = "Stratum_Feature";
  String parentUuid     = getUuid(parentTabGroup);

  String tabGroup     = "Stratum_Feature_Relationship";
  String refUnrelated = "Stratum_Feature_Relationship/Relationships/Unrelated_Loci";
  String refRelated   = "Stratum_Feature_Relationship/Relationships/Existing_Relationships";
  String refTrenchId  = "Stratum_Feature_Relationship/Relationships/Trench_ID";
  String refLocusId   = "Stratum_Feature_Relationship/Relationships/Locus_ID";
  String refSiteName  = "Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Site_Name";
  String refSiteYear  = "Stratum_Feature_Relationship/Vars/Stratum_Feature_Relationship_Year_of_Campaign";

  String trenchId   = getFieldValue(refTrenchId);
  String locusId    = getFieldValue(refLocusId);
  String siteName   = getFieldValue(refSiteName);
  String siteYear   = getFieldValue(refSiteYear);
  String parentRole = "{includes}";
  String unrelatedQ = "";
  String relatedQ   = "";

  if (isNull(trenchId)) {
    msgHead  = "{trench_id_required_head}";
    msgBody  = "{trench_id_required_body}";
    showWarning(msgHead, msgBody);
    return;
  }

  unrelatedQ += " SELECT 'unrelated' || char(0) || uuid || char(0) || response, response";
  unrelatedQ += "   FROM latestNonDeletedArchEntFormattedIdentifiers";
  unrelatedQ += "  WHERE uuid IN (";
  unrelatedQ += "         SELECT uuid";
  unrelatedQ += "           FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid)";
  unrelatedQ += "          WHERE attributename LIKE '% Trench ID'";
  unrelatedQ += "            AND measure = '{Trench_ID}'";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Locus ID'";
  unrelatedQ += "                    AND (measure = '{Locus_ID}' OR '{Locus_ID}' = ''))";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Site Name'";
  unrelatedQ += "                    AND measure = '{Site_Name}')";
  unrelatedQ += "            AND uuid IN (";
  unrelatedQ += "                 SELECT uuid";
  unrelatedQ += "                   FROM latestnondeletedaentvalue JOIN attributekey USING (attributeid) ";
  unrelatedQ += "                  WHERE attributename LIKE '% Year of Campaign'";
  unrelatedQ += "                    AND measure = '{Year_of_Campaign}')";
  unrelatedQ += "            AND uuid NOT IN (";
  unrelatedQ += "                 SELECT childuuid";
  unrelatedQ += "                   FROM parentchild";
  unrelatedQ += "                  WHERE parentuuid = '{parentUuid}'";
  unrelatedQ += "                    AND parentparticipatesverb = '{parentRole}')";
  unrelatedQ += "            AND uuid != '{parentUuid}')";
  unrelatedQ += "    AND aenttypename IN ('Locus', 'Legacy')";
  unrelatedQ += " ORDER BY response";
  unrelatedQ += " LIMIT ? OFFSET ?";
  unrelatedQ  = replaceFirst(unrelatedQ, "{Trench_ID}",        trenchId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Locus_ID}",         locusId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Locus_ID}",         locusId);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Site_Name}",        siteName);
  unrelatedQ  = replaceFirst(unrelatedQ, "{Year_of_Campaign}", siteYear);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentUuid}",       parentUuid);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentUuid}",       parentUuid);
  unrelatedQ  = replaceFirst(unrelatedQ, "{parentRole}",       parentRole);

  relatedQ += getCGChildQuery(parentUuid);

  populateCursorList(refUnrelated, unrelatedQ, 25);
  populateCursorList(refRelated,   relatedQ,   25);

  proposedChildUuid = null; proposedChildIdentifier = null;
  CGpopulateProposedRelationship();
}

void CGclearSearch() {
  String refUnrelated = "Stratum_Feature_Relationship/Relationships/Unrelated_Loci";
  String refRelated   = "Stratum_Feature_Relationship/Relationships/Existing_Relationships";

  String q = "SELECT '' WHERE 0 LIMIT ? OFFSET ?";
  populateCursorList(refUnrelated, q, 25);
  populateCursorList(refRelated,   q, 25);
}

void CGselectUnrelatedEntity() {
  String val = getListItemValue();
  if (isNull(val)) return;
  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("unrelated")) return;

  proposedChildUuid       = arguments[1];
  proposedChildIdentifier = arguments[2];

  CGpopulateProposedRelationship();
}

void CGaddRelationship() {
  String parentTabGroup = "Stratum_Feature";

  String relName    = "Stratum Feature - Locus";
  String parentUuid = getUuid(parentTabGroup);
  String childUuid  = proposedChildUuid;
  String parentRole = "{includes}";
  String childRole  = "{is_included_in}";
  String callback   = "CGaddRelationshipSucceeded()";

  if (isNull(parentUuid)) {
    String msgHead = "{logic_error_head}";
    String msgBody = "{logic_error_body}";
    showWarning(msgHead, msgBody);
    return;
  }
  if (isNull(childUuid)) {
    showToast("no_locus_selected");
    return;
  }

  saveEntitiesToHierRel(
      relName,
      parentUuid, childUuid,
      parentRole, childRole,
      callback
  );

  proposedChildUuid       = null;
  proposedChildIdentifier = null;
}

void CGaddRelationshipSucceeded() {
  String refProposedRel = "Stratum_Feature_Relationship/Relationships/Proposed_Relationship";

  populateWebViewHtml(refProposedRel, WEB_REL_BLANK);

  CGsearchRelationship();
}

void CGselectExistingRelationship() {
  String refSelectedRelRel = "Stratum_Feature_Relationship/Relationships/Selected_Relationship";

  String val = getListItemValue();
  if (isNull(val)) return;

  String[] arguments = val.split(SEP); // `SEP` defined by autogen as \0
  String   listName  = arguments[0];
  if (!listName.equals("related")) return;

  selectedRelId         = arguments[1];
  selectedRelIdentifier = arguments[2];

  populateWebViewHtml(refSelectedRelRel, selectedRelIdentifier);
}

void CGpopulateParentIdentiferRelationships() {
  String lotRef = "Stratum_Feature_Relationship/Relationships/Parent_Identifier";
  setFieldToIdentifier("Stratum_Feature", lotRef);
}

String getCGChildQuery(String parentUuid) {
  // `locusIdentifer` is defined in logic/shared.bsh
  String parentIdentifier = locusIdentifer;
  String relntypename     = "Stratum Feature - Locus";

  String relatedQ = "";
  relatedQ += "SELECT 'related' || char(0) || relationshipid || char(0) || '"+parentIdentifier+" ' || parentparticipatesverb ||' '|| response || char(0) || childuuid, '"+parentIdentifier+"'||' '||parentparticipatesverb||' '||response";
  relatedQ += "  FROM parentchild JOIN latestNonDeletedArchEntFormattedIdentifiers on (childuuid = uuid) ";
  relatedQ += "  JOIN createdmodifiedatby USING (uuid) ";
  relatedQ += " WHERE relationshipid IN (SELECT relationshipid  ";
  relatedQ += "                            FROM latestnondeletedrelationship JOIN relntype USING (relntypeid)  ";
  relatedQ += "                           WHERE relntypename = '"+relntypename+"') ";
  relatedQ += "   and parentuuid = '"+parentUuid+"' ";
  relatedQ += " ORDER BY createdat desc ";
  relatedQ += " LIMIT ? OFFSET ? ";
  return relatedQ;
}

//Overrides autogenerated definition
void onClickStratumFeatureStratumFeatureLociCreateRelationshipstoThisStratumFeature () {
  String tabgroup = "Stratum_Feature";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }

  newTab("Stratum_Feature_Relationship", true);
}
/***************************** DYNAMIC UI HELPERS *****************************/
void hideView(String refView) {
  String uuid       = getUuid(getTabGroupRef(refView));
  String attribName = getAttributeName(refView);
  String valView;

  if (hasView(refView)) {
    valView = getFieldValue(refView);
    removeView(refView);
  }

  if (!isNull(valView)) {
    // Flag Feature Type as `deleted`.
    q  = " INSERT INTO aentvalue (UUID, UserID, AttributeID, Deleted)";
    q += " SELECT '{uuid}', {userid}, attributeid, 1";
    q += " FROM  attributekey";
    q += " WHERE attributename = '{attributename}'";
    q  = replaceFirst(q, "{uuid}", uuid);
    q  = replaceFirst(q, "{userid}", userid);
    q  = replaceFirst(q, "{attributename}", attribName);

    fetchOne(q);
  }
}
/************************ DYNAMIC UI - OPEN/CLOSE SITE ************************/
/* There are two cases to handle:                                             */
/*   (a) When a record is newly created.                                      */
/*   (b) When a record has been loaded.                                       */
/*                                                                            */
/* Case (a) is handled by events which trigger a UI update.                   */
/*                                                                            */
/* Case (b) is handled by a callback to `showTabGroup`. This is implemented   */
/* by overwriting the auto-generated record loading function using @POSTPROC. */
/******************************************************************************/
addOnEvent("Locus",                                      "show",  "openLocusTabs()");
addOnEvent("Locus",                                      "fetch", "openLocusTabs(true)");
addOnEvent("Locus/General/Fill_in_Locus_Type_Details", "click", "openLocusTabs()");

void openLocusTabs() {
  openLocusTabs(false);
}

void openLocusTabs(Boolean showGeneralInformationTab){
  String refCut = "Locus/Cut";
  String refDep = "Locus/Deposit";
  String refSke = "Locus/Skeleton";
  String refCon = "Locus/Construction";
  String refGen = "Locus/General";

  String refCtxtType = "Locus/General/Locus_Type";
  String vocabName   = getMenuValue(refCtxtType);

  if (vocabName == null)
    vocabName = "";

  if (vocabName.equals("{Deposit}") || vocabName.equals("{Natural}")){
    cancelTab(refCut, false);
    cancelTab(refCon, false);
    cancelTab(refSke, false);
    showTab  (refDep);
  } else if (vocabName.equals("{Cut}")){
    cancelTab(refDep, false);
    cancelTab(refCon, false);
    cancelTab(refSke, false);
    showTab  (refCut);
  } else if (vocabName.equals("{Construction}")){
    cancelTab(refDep, false);
    cancelTab(refCut, false);
    cancelTab(refSke, false);
    showTab  (refCon);
  } else if (vocabName.equals("{Skeleton}")){
    cancelTab(refDep, false);
    cancelTab(refCut, false);
    cancelTab(refCon, false);
    showTab  (refSke);
  } else {
    cancelTab(refCut, false);
    cancelTab(refDep, false);
    cancelTab(refCon, false);
    cancelTab(refSke, false);
  }

  if(showGeneralInformationTab)
    showTab(refGen);
}
/************************* DYNAMIC UI - CONTEXT GROUP *************************/
// Prefetch this vocab seeing as it will be dynamically loaded multiple times
// throughout the module's runtime.
FEATURE_TYPE_VOCAB = new ArrayList();
fetchVocab("Feature Type", FEATURE_TYPE_VOCAB);

void updateStratumFeatureFields() {
  String ref       = "Stratum_Feature/General/Record_Type";
  String vocabName = getMenuValue(ref);
  String STRATUM   = "{Stratum}";
  String FEATURE   = "{Feature}";

  if (isNull(vocabName)) {
    setMenuValue(ref, FEATURE);
    updateStratumFeatureToFeature();
    return;
  }

  if (vocabName.equals(STRATUM)) updateStratumFeatureToStratum();
  if (vocabName.equals(FEATURE)) updateStratumFeatureToFeature();
}

void updateStratumFeatureToStratum() {
  hideStratumFeaturePrefix();
  hideStratumFeatureType();
  showStratumFeatureParens();
}

void updateStratumFeatureToFeature() {
  showStratumFeaturePrefix();
  showStratumFeatureType();
  hideStratumFeatureParens();
}

void hideStratumFeatureType() {
  hideView(
      "Stratum_Feature/General/Feature_Type",
      "Stratum_Feature/Vars/Last_Feature_Type"
  );
}

void hideStratumFeaturePrefix() {
  hideView(
      "Stratum_Feature/General/Feature_Prefix",
      "Stratum_Feature/Vars/Last_Feature_Prefix"
  );
}

void hideView(String refView, String refViewLast) {
  copyFieldValue(refView, refViewLast);
  hideView(refView);
}

void hideStratumFeatureParens() {
  setFieldValue("Stratum_Feature/Vars/L_Paren", "");
  setFieldValue("Stratum_Feature/Vars/R_Paren", "");
}

void showStratumFeatureType() {
  String refViewLast = "Stratum_Feature/Vars/Last_Feature_Type";
  String refView     = "Stratum_Feature/General/Feature_Type";
  String refGroup    = "Stratum_Feature/General/Feature_Type_Group";

  if (hasView(refView)) return;

  String label      = guessArch16nVal (refView);
  String attribName = getAttributeName(refView);

  // Create view
  FormInputDef viewDef = createViewDef();
  viewDef.createDropDown      ();
  viewDef.setLabel            (label);
  viewDef.setAttributeName    (attribName);
  viewDef.setAttributeType    ("vocab");
  viewDef.setAnnotationEnabled(true);
  viewDef.setCertaintyEnabled (true);
  viewDef.setInfoEnabled      (true);

  createView(refView, viewDef, refGroup);

  // Populate view
  Boolean hasNull = true;
  populateDropDown(refView, FEATURE_TYPE_VOCAB, hasNull);
  copyFieldValue(refViewLast, refView);
}

void showStratumFeaturePrefix() {
  String refViewLast = "Stratum_Feature/Vars/Last_Feature_Prefix";
  String refView     = "Stratum_Feature/General/Feature_Prefix";
  String refGroup    = "Stratum_Feature/General/Feature_Prefix_Group";

  if (hasView(refView)) return;

  String label      = guessArch16nVal (refView);
  String attribName = getAttributeName(refView);

  // Create view
  FormInputDef viewDef = createViewDef();
  viewDef.createTextField     ();
  viewDef.setLabel            (label);
  viewDef.setAttributeName    (attribName);
  viewDef.setAttributeType    ("measure");
  viewDef.setAnnotationEnabled(true);
  viewDef.setCertaintyEnabled (true);
  viewDef.setInfoEnabled      (true);
  viewDef.setStyleCss         ("required");

  createView(refView, viewDef, refGroup);
  copyFieldValue(refViewLast, refView);
}

void showStratumFeatureParens() {
  setFieldValue("Stratum_Feature/Vars/L_Paren", "(");
  setFieldValue("Stratum_Feature/Vars/R_Paren", ")");
}

addOnEvent("Stratum_Feature/General/Record_Type", "click", "updateStratumFeatureFields()");
addOnEvent("Stratum_Feature", "create",   "updateStratumFeatureFields()");
addOnEvent("Stratum_Feature", "prefetch", "updateStratumFeatureToFeature()");
addOnEvent("Stratum_Feature",    "fetch", "updateStratumFeatureFields()");
/****************************** DYNAMIC UI - FCN ******************************/
void updateFcnVolume() {
  String ref       = "FCN/General/FCN_Class";
  String vocabName = getMenuValue(ref);

  if (vocabName.equals("{Sediment}")) { showFcnVolume(); return; }
  if (vocabName.equals("{Other}"   )) { showFcnVolume(); return; }

  hideFcnVolume();
}

void hideFcnVolume() {
  hideView("FCN/General/Volume_Liters");
}

void showFcnVolume() {
  String refView  = "FCN/General/Volume_Liters";
  String refGroup = "FCN/General/Volume_Liters_Group";

  if (hasView(refView)) return;

  String label      = guessArch16nVal (refView);
  String attribName = getAttributeName(refView);

  // Create view
  FormInputDef viewDef = createViewDef();
  viewDef.createTextField     ("decimal");
  viewDef.setLabel            (label);
  viewDef.setAttributeName    (attribName);
  viewDef.setAttributeType    ("measure");
  viewDef.setAnnotationEnabled(true);
  viewDef.setCertaintyEnabled (true);
  viewDef.setInfoEnabled      (true);

  createView(refView, viewDef, refGroup);
}

addOnEvent("FCN/General/FCN_Class", "click", "updateFcnVolume()");
addOnEvent("FCN",                "prefetch", "showFcnVolume()");
addOnEvent("FCN",                   "fetch", "updateFcnVolume()");
/******************************* CONTEXT DATES ********************************/
addOnEvent("Locus/General/Add_Date_Closed", "click", "setLocusDateClosed()");
addOnEvent("Locus", "create", "setLocusDateOpened()");

void setTimestamp(String path) {
  setFieldValue(
      path,
      new java.text.SimpleDateFormat("yyyy-MM-dd HH:mm:ss z").format(new Date())
  );
}

void setLocusDateOpened() {
  String ref = "Locus/General/Date_Opened";
  setTimestamp(ref);
}

void setLocusDateClosed() {
  String ref = "Locus/General/Date_Closed";
  setTimestamp(ref);
}
/******************************* TEXTURE HELPER *******************************/
onEvent("Locus/Material_Helper/Update_Material", "click", "setTextureActual()");

// Overrides the original function definition using @POSTPROC.
void onClickLocusDepositMaterialHelper () {
  showTab("Locus/Material_Helper");
}

void setTextureActual(){
    String soilQuery= "SELECT vocabid " +
                      "  FROM vocabulary JOIN attributekey USING (attributeid) "+
                      " WHERE attributeName = 'Material' "+
                      "   AND vocabname = '" + getMenuValue("Locus/Material_Helper/Material_Helper") + "' ";
    //This function makes the hierarchical soil texture selector write to the texture dropdown. We should discuss.
    Log.d("foo1", soilQuery);

    fetchOne(soilQuery, new FetchCallback() {
        onFetch(textureToSet) {
            if(!isNull(textureToSet)){
                Log.d("foo1", textureToSet.get(0));
                setFieldValue("Locus/Deposit/Material", textureToSet.get(0));
            } else {
                showToast("{soil_texture_no_match}");
            }
            cancelTab("Locus/Material_Helper", false);
            showTab("Locus/Deposit");
        }
    });
}
/****************************** SEARCH EXTENSION ******************************/
/* Implements an extension to the search page which allows users to           */
/* constrain their searches by user.                                          */
/******************************************************************************/
delOnEvent("Control/Search", "show", "search()");
addOnEvent("Control/Search", "show", "populateSelectUser()");
addOnEvent("Control/Search", "show", "populateSite()");

addOnEvent("Control/Search/Select_User", "click", "search()");
addOnEvent("Control/Search/Select_Site", "click", "search()");

void populateSelectUser(){
  String refSearchUsers = "Control/Search/Select_User";
  String getNonDeletedUsersQuery = "SELECT userid, fname || ' ' || lname "+
                                   "  FROM user "+
                                   " WHERE userdeleted is null "+
                                   " UNION " +
                                   "SELECT -1, '{All}'";

  fetchAll(getNonDeletedUsersQuery, new FetchCallback() {
    onFetch(result) {
      populateDropDown(refSearchUsers, result, false);
      search();
    }
  });
}

void populateSite() {
  String refSite = "Control/Search/Select_Site";

  String q = "";
  q += " SELECT uuid, response, attributename, measure";
  q += "   FROM latestNonDeletedAentvalue";
  q += "   JOIN latestNonDeletedArchEntFormattedIdentifiers USING (uuid)";
  q += "   JOIN attributekey USING (attributeid)";
  q += "  WHERE attributename = 'Site Site Name'";
  q += "     OR attributename = 'Site Year of Campaign'";

  FetchCallback popSite = new FetchCallback() {
    onFetch(result) {
      List normalised = normaliseSiteResult(result);
      populateDropDown(refSite, normalised);
    }
  };

  fetchAll(q, popSite);
}

List normaliseSiteResult(List result) {
  Map  normalisedResultMap  = new HashMap();
  List normalisedResultList = new ArrayList();

  for (List row : result) {
    String uuid     = row.get(0);
    String response = row.get(1);
    String attrName = row.get(2);
    String attrVal  = row.get(3);

    List mapRow = normalisedResultMap.get(uuid);
    mapRow = updateMapRow(mapRow, "Response", response);
    mapRow = updateMapRow(mapRow, attrName,   attrVal);

    normalisedResultMap.put(uuid, mapRow);
  }

  insertListRow(normalisedResultList, "", "", "{All}");
  for (List val : normalisedResultMap.values()) {
    String response = val.get(0);
    String siteName = val.get(1);
    String siteYear = val.get(2);

    insertListRow(normalisedResultList, siteName, siteYear, response);
  }

  return normalisedResultList;
}

List updateMapRow(List row, String key, String val) {
  String RESPONSE         = "Response";
  String SITE_NAME        = "Site Name";
  String YEAR_OF_CAMPAIGN = "Year of Campaign";

  if (row == null) {
    row = new ArrayList();
    row.add("");
    row.add("");
    row.add("");
  } else {
    row = new ArrayList(row);
  }

  if (key == null)
    return row;
  else if (key.contains(RESPONSE        )) row.set(0, val);
  else if (key.contains(SITE_NAME       )) row.set(1, val);
  else if (key.contains(YEAR_OF_CAMPAIGN)) row.set(2, val);

  return row;
}

void insertListRow(
    List   normalisedList,
    String siteName,
    String siteYear,
    String response
) {
    List normalisedRow = new ArrayList();
    normalisedRow.add(siteName + SEP + siteYear);
    normalisedRow.add(response);

    normalisedList.add(normalisedRow);
}

// Overrides auto-generated definition
void search(){
  String tabgroup = "Control";
  String refEntityList  = tabgroup + "/Search/Entity_List";
  String refSearchTerm  = tabgroup + "/Search/Search_Term";
  String refEntityTypes = tabgroup + "/Search/Entity_Types";
  String refSelectUser  = tabgroup + "/Search/Select_User";
  String refSelectSite  = tabgroup + "/Search/Select_Site";

  String type = getFieldValue(refEntityTypes);
  String term = getFieldValue(refSearchTerm);
  String user = getFieldValue(refSelectUser);
  String name = getSearchSiteName(refSelectSite);
  String year = getSearchSiteYear(refSelectSite);
  if (isNull(user)) return;
  String searchQuery = "SELECT uuid, response " +
                       "  FROM latestNonDeletedArchEntFormattedIdentifiers  " +
                       " WHERE uuid in (SELECT uuid " +
                       "                  FROM latestNonDeletedArchEntIdentifiers " +
                       "                 WHERE measure LIKE '{term}%'  " +
                       "                   AND ( aenttypename LIKE '{type}' OR '' = '{type}' ) " +
                       "                   AND ( userid = {user} OR -1 = {user}) " +
                       "                ) " +
                       "  AND  ( " +
                       "           ('{name}' = '\\0' AND '{year}' = '\\0') OR" +
                       "           uuid IN (" +
                       "            SELECT uuid" +
                       "              FROM latestnondeletedaentvalue" +
                       "              JOIN attributekey USING (attributeid)" +
                       "             WHERE attributename LIKE '% Site Name'" +
                       "               AND measure = '{name}'" +
                       "               AND uuid IN (" +
                       "                    SELECT uuid" +
                       "                      FROM latestnondeletedaentvalue" +
                       "                      JOIN attributekey USING (attributeid)" +
                       "                     WHERE attributename LIKE '% Year of Campaign'" +
                       "                       AND measure = '{year}'" +
                       "               )" +
                       "           )" +
                       "       )" +
                       " ORDER BY response " +
                       " LIMIT ? " +
                       "OFFSET ? ";
  searchQuery = replaceFirst(searchQuery, "{term}", term);
  searchQuery = replaceFirst(searchQuery, "{type}", type);
  searchQuery = replaceFirst(searchQuery, "{type}", type);
  searchQuery = replaceFirst(searchQuery, "{user}", user);
  searchQuery = replaceFirst(searchQuery, "{user}", user);
  searchQuery = replaceFirst(searchQuery, "{name}", name);
  searchQuery = replaceFirst(searchQuery, "{year}", year);
  searchQuery = replaceFirst(searchQuery, "{name}", name);
  searchQuery = replaceFirst(searchQuery, "{year}", year);

  populateCursorList(refEntityList, searchQuery, 25);
  refreshTabgroupCSS(tabgroup);

  Log.d("Module", "Search query: " + searchQuery);
}

String getSearchSiteName(String ref) {
  return getSearchSiteField(ref, 0);
}

String getSearchSiteYear(String ref) {
  return getSearchSiteField(ref, 1);
}

String getSearchSiteField(String ref, int index) {
  String   nameYear = getFieldValue(ref);
  if (isNull(nameYear))
    nameYear = "";

  String[] splitted = nameYear.split(SEP);
  if (index < splitted.length)
    return splitted[index];
  else
    return "\\0";
}
/***************************** CUSTOM VALIDATION ******************************/

String getName(String ref, String defaultName) {
  String refOri = "Locus/Cut/Orientation_Degree";

  if (ref.equals(refOri))
    return defaultName + " {Must_be_between_0_0_and_90_0}";

  return defaultName;
}

String getCond(String ref, String defaultCond) {
  String refTab  = getTabRef(ref);

  if (refTab.equals("Locus/Cut"      ))
    return "isSelected(\"Locus/General/Locus_Type\", \"{Cut}\")";
  if (refTab.equals("Locus/Deposit"  ))
    return "isSelected(\"Locus/General/Locus_Type\", \"{Deposit}\")" +
      " ||  isSelected(\"Locus/General/Locus_Type\", \"{Natural}\")";
  if (refTab.equals("Locus/Skeleton" ))
    return "isSelected(\"Locus/General/Locus_Type\", \"{Skeleton}\")";
  if (refTab.equals("Locus/Construction"))
    return "isSelected(\"Locus/General/Locus_Type\", \"{Construction}\")";

  if (ref.equals("Stratum_Feature/General/Feature_Prefix"))
    return "isSelected(\"Stratum_Feature/General/Record_Type\", \"{Feature}\")";

  return defaultCond;
}

// Overrides autogenerated definition
boolean isValidField(String ref) {
  String refOri = "Locus/Cut/Orientation_Degree";
  if (!ref.equals(refOri))
    return !isNull(getFieldValue(ref)); // Do blank check

  // Do range check
  String val = getFieldValue(refOri);
  double dblVal;
  try {
    dblVal = Double.parseDouble(val);
  } catch(NumberFormatException e) {
    dblVal = -1.0;
  }

  double fltMin =  0.0;
  double fltMax = 90.0;

  return dblVal >= fltMin &&
         dblVal <= fltMax;
}

// Overrides autogenerated definition
List fieldPair(String ref, String name, String cond) {
  String refOri = "Locus/Cut/Orientation_Degree";

  name = getName(ref, name);
  cond = getCond(ref, cond);

  List fp = new ArrayList();
  fp.add(ref);
  fp.add(name);
  fp.add(cond);

  return fp;
}
/******************************** DATE CLOSED *********************************/
addOnEvent("Date_Closed/Date_Closed/Set_Date_Closed", "click", "setDateClosed()");
addOnEvent("Date_Closed/Date_Closed/Cancel",          "click", "goBack()");

// Overrides autogenerated function
void onClickTrenchTrenchSetDateClosed() {
  String head     = "{proceed_to_date_picker_head}";
  String body     = "{proceed_to_date_picker_body}";
  String cbOkay   = "goToDateClosedTabGroup()";
  String cbCancel = "";

  showAlert(head, body, cbOkay, cbCancel);
}

void goToDateClosedTabGroup() {
  newTab("Date_Closed", true);
}

void setDateClosed() {
  String src = "Date_Closed/Date_Closed/Date_Closed";
  String dst = "Trench/Trench/Date_Closed";

  // Change the date picker's DD/MM/YYYY format to YYYY/MM/DD
  String val;
  val = getFieldValue(src);
  val = val.split("/")[2] + "/" +
        val.split("/")[1] + "/" +
        val.split("/")[0];

  setFieldValue(dst, val);
  goBack();
}
/*************************** CREATE NEW SITE BUTTON ***************************/

// Overrides autogenerated definition
void onClickControlSiteCreateNewSite() {
  parentTabgroup__ = "Control";

  tryCreateNewSite();
}

void tryCreateNewSite() {
  String siteName = getFieldValue("Control/Site/New_Site_Name");
  String siteYear = getFieldValue("Control/Site/Year_of_Campaign");

  String q = "";
  q += " SELECT response";
  q += "   FROM latestNonDeletedArchEntFormattedIdentifiers";
  q += "  WHERE uuid IN (";
  q += "         SELECT uuid";
  q += "           FROM latestnondeletedaentvalue";
  q += "           JOIN attributekey USING (attributeid)";
  q += "          WHERE attributename = 'Site Site Name'";
  q += "            AND measure = '{Site_Site_Name}'";
  q += "            AND uuid IN (";
  q += "                 SELECT uuid";
  q += "                   FROM latestnondeletedaentvalue";
  q += "                   JOIN attributekey USING (attributeid)";
  q += "                  WHERE attributename = 'Site Year of Campaign'";
  q += "                    AND measure = '{Site_Year_of_Campaign}'))";
  q += "    AND aenttypename = 'Site'";
  q  = replaceFirst(q, "{Site_Site_Name}",        siteName);
  q  = replaceFirst(q, "{Site_Year_of_Campaign}", siteYear);

  FetchCallback callback = new FetchCallback() {
    onFetch(result) {
      if      (result        == null) newSite();
      else if (result.size() == 0   ) newSite();
      else                            confirmNewSite();
    }
  };

  fetchAll(q, callback);
}

void confirmNewSite() {
  String head  = "{site_already_exists_head}";
  String body  = "{site_already_exists_body}";
  String cbOk  = "";
  String cbBad = "newSite()";

  showAlert(head, body, cbOk, cbBad);
}
/************************** CREATE NEW TRENCH BUTTON **************************/

// Overrrides autogenerated definition
void onClickSiteSiteTrenches() {
  String tabgroup = "Site";
  if (isNull(getUuid(tabgroup))){
    showToast("{You_must_save_this_tabgroup_first}");
    return;
  }
  parentTabgroup   = tabgroup;
  parentTabgroup__ = tabgroup;
  tryCreateNewTrench();
}

void tryCreateNewTrench () {
  String parentUuid = getUuid(getDisplayedTabGroup());
  String trenchId   = getFieldValue("Site/Site/Trench_ID");

  String q = "";
  q += "SELECT childuuid, response ";
  q += "  FROM parentchild ";
  q += "  JOIN latestNonDeletedArchEntFormattedIdentifiers ON (childuuid = uuid) ";
  q += "  JOIN createdmodifiedatby USING (uuid) ";
  q += " WHERE relationshipid IN (SELECT relationshipid  ";
  q += "                            FROM latestnondeletedrelationship JOIN relntype USING (relntypeid) ";
  q += "                           WHERE relntypename = 'Site - Trench') ";
  q += "   AND parentuuid = '" + parentUuid + "' ";
  q += "   AND (childaenttypename = 'Trench') ";
  q += "   AND childuuid IN (";
  q += "           SELECT uuid";
  q += "             FROM latestnondeletedaentvalue";
  q += "             JOIN attributekey USING (attributeid)";
  q += "            WHERE attributename = 'Trench Trench ID'";
  q += "              AND measure = '" + trenchId + "')";

  FetchCallback callback = new FetchCallback() {
    onFetch(result) {
      if      (result        == null) newTrench();
      else if (result.size() == 0   ) newTrench();
      else                            confirmNewTrench();
    }
  };

  fetchAll(q, callback);
}

void confirmNewTrench() {
  String head  = "{trench_already_exists_head}";
  String body  = "{trench_already_exists_body}";
  String cbOk  = "";
  String cbBad = "newTrench()";

  showAlert(head, body, cbOk, cbBad);
}
/************************* FCN ENTITY LIST POPULATION *************************/
addOnEvent("Trench", "create", "populateTrenchFcns()");
addOnEvent("Trench", "fetch",  "populateTrenchFcns()");
addOnEvent("FCN",    "save",   "populateTrenchFcns()");
addOnEvent("Trench/FCNs/List_of_Existing_FCNs", "click", "loadEntity()");

void populateTrenchFcns() {
  String parentUuid    = getUuid("Trench");
  String refEntityList = "Trench/FCNs/List_of_Existing_FCNs";

  String q = "";
  q += "SELECT childuuid, response";
  q += "  FROM parentchild JOIN latestNonDeletedArchEntFormattedIdentifiers ON (childuuid = uuid)";
  q += "  JOIN createdmodifiedatby USING (uuid)";
  q += " WHERE (relationshipid IN (SELECT relationshipid";
  q += "                            FROM latestnondeletedrelationship JOIN relntype USING (relntypeid)";
  q += "                           WHERE relntypename IN ('Trench - FCN'))";
  q += "   AND parentuuid = '{parentUuid}')";
  q += "    OR (parentuuid IN (SELECT childuuid";
  q += "                       FROM parentchild";
  q += "                      WHERE relationshipid in (SELECT relationshipid";
  q += "                                                 FROM latestnondeletedrelationship JOIN relntype USING (relntypeid)";
  q += "                                                WHERE relntypename IN ('Trench - Locus'))";
  q += "                        AND parentuuid = '{parentUuid}'))";
  q += "   AND childaenttypename IN ('FCN')";
  q += " ORDER BY createdat DESC";
  q += " LIMIT ? OFFSET ?";
  q  = replaceFirst(q, "{parentUuid}", parentUuid);
  q  = replaceFirst(q, "{parentUuid}", parentUuid);

  populateCursorList(refEntityList, q, 25);
}


/*************************** CUSTOM DIARY TIMESTAMP ***************************/
import java.text.SimpleDateFormat;

addOnEvent("Diary", "create", "populateDiaryTimestamp()");

void populateDiaryTimestamp() {
  String           ref    = "Diary/Diary/Timestamp";
  String           fmt    = "yyyy-MM-dd";
  SimpleDateFormat dFmt   = new SimpleDateFormat(fmt);
  Date             now    = new Date();
  String           nowStr = dFmt.format(now);

  setFieldValue(ref, nowStr);
}


/******************************************************************************/
/*                                    INIT                                    */
/*                                                                            */
/* Stuff which needs to be done last.                                         */
/******************************************************************************/
bindOnEvents();
